<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Wilde">
<meta name="theme-color" content="#0a0a0a">
<title>Wilde</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0a;
  --surface: #141414;
  --surface2: #1e1e1e;
  --border: #242424;
  --border2: #2e2e2e;
  --text: #f0f0f0;
  --muted: #555;
  --muted2: #888;
  --accent: #e8ff47;
  --heart: #ff4d6d;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; min-height: 100vh; }
body { overflow-x: hidden; }

/* BACK TO TOP */
#backToTop {
  position: fixed;
  bottom: 24px;
  right: 16px;
  z-index: 350;
  width: 36px; height: 36px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s, transform 0.2s, bottom 0.35s cubic-bezier(0.4,0,0.2,1);
  color: var(--muted2);
}
#backToTop.visible { opacity: 1; pointer-events: auto; }
#backToTop.tray-up { bottom: 170px; }
#backToTop:hover { color: var(--accent); border-color: var(--accent); transform: translateY(-2px); }
#backToTop:active { transform: scale(0.92); }
#backToTop svg { width: 16px; height: 16px; }

/* INSTALL BANNER */
#installBanner { display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999; background: var(--accent); color: #0a0a0a; padding: 16px 20px; gap: 12px; align-items: center; font-family: 'Space Mono', monospace; font-size: 13px; border-top: 2px solid #0a0a0a; }
#installBanner.show { display: flex; }
#installBanner .bt { flex: 1; line-height: 1.5; }
#installBanner .bt strong { display: block; font-size: 14px; margin-bottom: 2px; }
#installBanner button { background: #0a0a0a; color: var(--accent); border: none; padding: 8px 14px; border-radius: 6px; font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; }

/* HEADER */
header { position: sticky; top: 0; z-index: 100; background: var(--bg); border-bottom: 1px solid var(--border); padding: 0 12px; }
.header-top { display: flex; align-items: center; height: 52px; gap: 8px; }
.logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 20px; letter-spacing: -0.03em; color: var(--text); flex-shrink: 0; cursor: pointer; user-select: none; }
.logo span { color: var(--accent); }

.search-wrap { flex: 1; min-width: 0; position: relative; }
.search-wrap svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); width: 16px; height: 16px; pointer-events: none; }
#searchInput { width: 100%; background: var(--surface); border: 1px solid var(--border2); border-radius: 8px; padding: 8px 12px 8px 34px; color: var(--text); font-family: 'Syne', sans-serif; font-size: 14px; outline: none; transition: border-color 0.15s; }
#searchInput:focus { border-color: var(--accent); }
#searchInput::placeholder { color: var(--muted); }

/* FILTER TOGGLE PILL */
.filter-toggle-btn { padding: 7px 12px; border-radius: 999px; font-size: 12px; font-weight: 700; cursor: pointer; border: 1.5px solid var(--border2); background: var(--surface); color: var(--muted2); font-family: 'Syne', sans-serif; white-space: nowrap; flex-shrink: 0; transition: all 0.15s; display: flex; align-items: center; gap: 5px; }
.filter-toggle-btn:hover { color: var(--text); border-color: var(--border2); }
.filter-toggle-btn.active { background: var(--surface2); color: var(--text); border-color: var(--accent); }
.filter-toggle-btn .filter-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); display: none; flex-shrink: 0; }
.filter-toggle-btn.has-filters .filter-dot { display: block; }

/* FILTER DRAWER */
#filterDrawer { 
  background: var(--bg); 
  overflow: hidden; 
  max-height: 0; 
  transition: max-height 0.3s cubic-bezier(0.4,0,0.2,1), border-bottom-width 0.3s; 
  border-bottom: 0px solid var(--border);
  position: sticky;
  top: 53px;
  z-index: 99;
}
#filterDrawer.open { max-height: 600px; border-bottom: 1px solid var(--border); }

/* FILTER */
.filter-section { background: var(--bg); }
.filter-label { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; padding: 8px 20px 0; }
.filter-row { display: flex; gap: 6px; padding: 8px 16px 10px; flex-wrap: wrap; }
#muscleRow { max-height: 96px; overflow-y: auto; scrollbar-width: none; }
#muscleRow::-webkit-scrollbar { display: none; }
.pill { padding: 5px 14px; border-radius: 999px; font-size: 12px; font-weight: 700; cursor: pointer; border: 1.5px solid var(--border); white-space: nowrap; transition: all 0.15s; background: var(--surface); color: var(--muted2); flex-shrink: 0; }
.pill:hover { color: var(--text); border-color: var(--border2); }
.pill.active { background: var(--accent); color: #0a0a0a; border-color: var(--accent); }
.pill.region-upper.active { background: #60a5fa; border-color: #60a5fa; color: #000; }
.pill.region-core.active { background: #34d399; border-color: #34d399; color: #000; }
.pill.region-lower.active { background: #f472b6; border-color: #f472b6; color: #000; }
.pill.diff-novice.active { background: #4ade80; border-color: #4ade80; color: #000; }
.pill.diff-beginner.active { background: #a3e635; border-color: #a3e635; color: #000; }
.pill.diff-intermediate.active { background: #facc15; border-color: #facc15; color: #000; }
.pill.diff-advanced.active { background: #fb923c; border-color: #fb923c; color: #000; }
.pill.diff-expert.active { background: #f87171; border-color: #f87171; color: #000; }
.pill.diff-master.active { background: #e879f9; border-color: #e879f9; color: #000; }

/* EDIT MODE INDICATOR */
#editModeBar { 
  display: none; 
  position: fixed; 
  top: 0; left: 0; right: 0; 
  z-index: 9998; 
  background: var(--accent); 
  color: #0a0a0a; 
  padding: 6px 16px; 
  font-family: 'Space Mono', monospace; 
  font-size: 11px; 
  font-weight: 700; 
  align-items: center; 
  justify-content: space-between;
  gap: 12px;
}
#editModeBar.show { display: flex; }
#editModeBar .em-label { display: flex; align-items: center; gap: 6px; }
#editModeBar .em-dot { width: 6px; height: 6px; border-radius: 50%; background: #0a0a0a; animation: emPulse 1.2s ease-in-out infinite; }
@keyframes emPulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
#editModeBar .em-exit { background: #0a0a0a; color: var(--accent); border: none; padding: 4px 12px; border-radius: 5px; font-family: 'Space Mono', monospace; font-size: 10px; font-weight: 700; cursor: pointer; white-space: nowrap; }
#editModeBar .em-exit:hover { opacity: 0.8; }

/* FAVORITES PILL */
.pill.fav-pill { display: flex; align-items: center; gap: 5px; }
.pill.fav-pill svg { width: 11px; height: 11px; flex-shrink: 0; }
.pill.fav-pill.active { background: var(--heart); border-color: var(--heart); color: #fff; }
.pill.fav-pill.active svg { fill: #fff; stroke: #fff; }

/* RESULTS BAR */
.results-bar { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-bottom: 1px solid var(--border); }
.results-count { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); flex: 1; }
.results-count strong { color: var(--accent); }
.sort-select { background: var(--surface); border: 1px solid var(--border2); border-radius: 6px; padding: 4px 8px; color: var(--muted2); font-family: 'Space Mono', monospace; font-size: 11px; outline: none; cursor: pointer; }

/* ROULETTE BUTTON â€” now lives in results bar */
.roulette-btn { 
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 8px; font-size: 15px; cursor: pointer; 
  border: 1.5px solid var(--border2); background: var(--surface); 
  flex-shrink: 0; transition: all 0.18s; 
  padding: 0; line-height: 1;
}
.roulette-btn:hover { border-color: var(--accent); background: var(--surface2); transform: scale(1.08); }
.roulette-btn:active { transform: scale(0.9); }
@keyframes rouletteSpin { 0%{transform:rotate(0deg) scale(1)} 50%{transform:rotate(360deg) scale(1.2)} 100%{transform:rotate(360deg) scale(1)} }
.roulette-btn.spinning { animation: rouletteSpin 0.45s ease; pointer-events: none; }

/* LIST */
#listContainer { padding: 12px 16px 140px; }

.ex-card { 
  background: var(--surface); 
  border: 1px solid var(--border); 
  border-radius: 10px; 
  margin-bottom: 8px; 
  overflow: hidden; 
  transition: border-color 0.15s; 
  cursor: pointer; 
}
.ex-card.expanded {
  border-color: var(--border2);
  background: #161616;
}

.ex-card-main { 
  display: flex; 
  align-items: flex-start; 
  padding: 12px 14px; 
  gap: 12px; 
}

.muscle-bar { 
  width: 3px; 
  height: 38px; 
  border-radius: 2px; 
  flex-shrink: 0; 
  margin-top: 2px; 
}

.ex-info { flex: 1; min-width: 0; }

.ex-name { 
  font-size: 14px; 
  font-weight: 700; 
  line-height: 1.3; 
  margin-bottom: 4px; 
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.ex-card.expanded .ex-name {
  display: block;
  overflow: visible;
  -webkit-line-clamp: unset;
}

.ex-sub { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
.ex-sub .tag { display: inline-flex; align-items: center; justify-content: center; }
.tag { font-family: 'Space Mono', monospace; font-size: 10px; padding: 2px 7px; border-radius: 4px; display: inline-flex; align-items: center; line-height: 1.4; }
.tag-muscle { background: rgba(255,255,255,0.07); color: var(--muted2); }

.tag-diff.novice { background: rgba(74,222,128,0.12); color: #4ade80; }
.tag-diff.beginner { background: rgba(163,230,53,0.12); color: #a3e635; }
.tag-diff.intermediate { background: rgba(250,204,21,0.12); color: #facc15; }
.tag-diff.advanced { background: rgba(251,146,60,0.12); color: #fb923c; }
.tag-diff.expert { background: rgba(248,113,113,0.12); color: #f87171; }
.tag-diff.master { background: rgba(232,121,249,0.12); color: #e879f9; }

.tag-equip { background: rgba(255,255,255,0.04); color: var(--muted); }
.ex-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; margin-top: 2px; }
.yt-icon { opacity: 0.5; flex-shrink: 0; }
.ex-card.expanded .yt-icon { display: none; }
/* Hide add-session and map btn on collapsed cards; show only when expanded */
.ex-card:not(.expanded) .add-session-btn { display: none; }
.ex-card:not(.expanded) .map-btn { display: none; }
/* Hide chevron entirely */
.chevron { display: none; }
/* MAP BUTTON (on card) */
.map-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s, color 0.15s;
  flex-shrink: 0;
  color: var(--muted2);
}
.map-btn:hover { transform: scale(1.2); color: var(--accent); }
.map-btn:active { transform: scale(0.9); }
.map-btn svg { width: 16px; height: 16px; }
/* HEART BUTTON */
.heart-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s;
  flex-shrink: 0;
}
.heart-btn:hover { transform: scale(1.2); }
.heart-btn:active { transform: scale(0.9); }
.heart-btn svg { width: 20px; height: 20px; min-width: 18px; min-height: 18px; transition: all 0.2s; }
.heart-btn.favorited svg { fill: var(--heart); stroke: var(--heart); filter: drop-shadow(0 0 4px rgba(255,77,109,0.5)); }
.heart-btn:not(.favorited) svg { fill: none; stroke: var(--muted2); }
/* Pop animation when favoriting */
@keyframes heartPop {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.35); }
  70%  { transform: scale(0.9); }
  100% { transform: scale(1); }
}
.heart-btn.pop { animation: heartPop 0.35s ease forwards; }

/* DETAIL */
.ex-detail { display: none; padding: 0 14px 14px; border-top: 1px solid var(--border); }
.ex-card.expanded .ex-detail { display: block; }
.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
.detail-item label { font-family: 'Space Mono', monospace; font-size: 9px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); display: block; margin-bottom: 3px; }
.detail-item p { font-size: 13px; font-weight: 600; color: var(--text); }
.detail-item.full { grid-column: 1 / -1; }
.video-btn { margin-top: 12px; display: flex; align-items: center; gap: 8px; background: #ff0000; color: white; padding: 10px 16px; border-radius: 8px; font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; cursor: pointer; border: none; width: 100%; justify-content: center; text-decoration: none; transition: background 0.15s; }
.video-btn:hover { background: #cc0000; }
.no-video { margin-top: 10px; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); }

/* MUSCLE DIAGRAM */
.muscle-diagram-wrap {
  grid-column: 1 / -1;
  display: flex;
  gap: 0;
  align-items: flex-start;
  margin-top: 10px;
  padding: 12px 4px 10px;
  border-radius: 10px;
  background: #080808;
  border: 1px solid #1a1a1a;
}
.diagram-col {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  flex: 1;
  min-width: 0;
}
.diagram-col svg {
  width: 100%;
  max-width: 120px;
  height: auto;
  display: block;
}
.diagram-label {
  font-family: 'Space Mono', monospace;
  font-size: 8px;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: #383838;
  text-align: center;
}
/* All polygons default to a very dark, barely-visible grey */
.body-svg polygon {
  fill: #1f1f1f;
  stroke: none;
  transition: fill 0.2s ease, filter 0.2s ease;
}
/* The single active muscle lights up in neon yellow */
.body-svg polygon.hi {
  fill: #e8ff47;
  filter: drop-shadow(0 0 5px rgba(232,255,71,0.5));
}
/* Dim the irrelevant view */
.diagram-col.dim { opacity: 0.18; }
.diagram-divider {
  width: 1px;
  background: #1c1c1c;
  align-self: stretch;
  margin: 6px 0;
  flex-shrink: 0;
}

/* INLINE EDIT FORM (edit mode on cards) */
.edit-mode-card { border-color: rgba(232,255,71,0.2) !important; }
.edit-mode-card .ex-card-main { cursor: pointer; }
.edit-mode-detail { padding: 0 14px 14px; border-top: 1px solid #2a2a0a; }
.inline-edit-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 12px;
}
.inline-field { display: flex; flex-direction: column; gap: 3px; }
.inline-field.full { grid-column: 1 / -1; }
.inline-field label {
  font-family: 'Space Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--muted);
}
.inline-field input, .inline-field select {
  background: #1a1a0d;
  border: 1px solid #333320;
  border-radius: 6px;
  padding: 7px 9px;
  color: var(--text);
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  outline: none;
  transition: border-color 0.15s;
  width: 100%;
}
.inline-field input:focus, .inline-field select:focus { border-color: var(--accent); }
.inline-field select option { background: #1a1a0d; }
.inline-edit-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}
.inline-save-btn {
  flex: 1;
  padding: 9px;
  background: var(--accent);
  color: #0a0a0a;
  border: none;
  border-radius: 7px;
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  transition: opacity 0.15s;
}
.inline-save-btn:hover { opacity: 0.85; }
.inline-delete-btn {
  padding: 9px 14px;
  background: rgba(239,68,68,0.1);
  color: #f87171;
  border: 1px solid rgba(239,68,68,0.2);
  border-radius: 7px;
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.15s;
}
.inline-delete-btn:hover { background: rgba(239,68,68,0.2); }

/* LOADING */
.loading-state { text-align: center; padding: 60px 20px; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 13px; }
.spinner { width: 32px; height: 32px; border: 3px solid var(--border2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state { text-align: center; padding: 60px 20px; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 13px; }
.empty-state .big { font-size: 40px; margin-bottom: 12px; }
.load-more-btn { display: block; width: 100%; padding: 14px; background: var(--surface); border: 1px solid var(--border2); border-radius: 10px; color: var(--muted2); font-family: 'Space Mono', monospace; font-size: 12px; cursor: pointer; text-align: center; margin-top: 8px; transition: all 0.15s; }
.load-more-btn:hover { border-color: var(--accent); color: var(--accent); }

/* PIN MODAL */
#pinModal { display: none; position: fixed; inset: 0; z-index: 9000; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
#pinModal.open { display: flex; }
.pin-box { background: var(--surface); border: 1px solid var(--border2); border-radius: 16px; padding: 32px; width: 300px; text-align: center; }
.pin-box h3 { font-size: 18px; font-weight: 800; margin-bottom: 8px; }
.pin-box p { font-size: 12px; color: var(--muted2); font-family: 'Space Mono', monospace; margin-bottom: 20px; }
.pin-box input { width: 100%; background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px; padding: 12px; color: var(--text); font-family: 'Syne', sans-serif; font-size: 16px; outline: none; text-align: center; letter-spacing: 0.1em; margin-bottom: 12px; transition: border-color 0.15s; }
.pin-box input:focus { border-color: var(--accent); }
.pin-box input.error { border-color: #f87171; animation: shake 0.3s; }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }
.pin-btn { width: 100%; padding: 12px; background: var(--accent); color: #0a0a0a; border: none; border-radius: 8px; font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; margin-bottom: 8px; }
.pin-cancel { background: none; border: none; color: var(--muted2); font-family: 'Space Mono', monospace; font-size: 11px; cursor: pointer; width: 100%; padding: 6px; }

/* EDIT PANEL */
#editPanel { display: none; position: fixed; inset: 0; z-index: 500; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); overflow-y: auto; padding: 20px; }
#editPanel.open { display: flex; flex-direction: column; align-items: center; }
.edit-panel-inner { background: var(--surface); border: 1px solid var(--border2); border-radius: 16px; width: 100%; max-width: 600px; padding: 24px; margin: auto; }
.edit-panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.edit-panel-header h2 { font-size: 18px; font-weight: 800; }
.edit-panel-header h2 span { color: var(--accent); }
.close-btn { width: 32px; height: 32px; background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px; color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
.edit-mode-tabs { display: flex; gap: 6px; margin-bottom: 20px; }
.mode-tab { flex: 1; padding: 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--muted2); font-family: 'Space Mono', monospace; font-size: 11px; cursor: pointer; text-align: center; transition: all 0.15s; }
.mode-tab.active { background: var(--accent); color: #0a0a0a; border-color: var(--accent); }
.form-group { margin-bottom: 14px; }
.form-group label { display: block; font-family: 'Space Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted2); margin-bottom: 5px; }
.form-group input, .form-group select { width: 100%; background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px; padding: 10px 12px; color: var(--text); font-family: 'Syne', sans-serif; font-size: 14px; outline: none; transition: border-color 0.15s; }
.form-group input:focus, .form-group select:focus { border-color: var(--accent); }
.form-group select option { background: var(--surface2); }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.btn-primary { width: 100%; padding: 12px; background: var(--accent); color: #0a0a0a; border: none; border-radius: 8px; font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 4px; transition: opacity 0.15s; }
.btn-primary:hover { opacity: 0.85; }
.btn-danger { width: 100%; padding: 10px; background: rgba(239,68,68,0.12); color: #f87171; border: 1px solid rgba(239,68,68,0.2); border-radius: 8px; font-family: 'Space Mono', monospace; font-size: 12px; cursor: pointer; margin-top: 8px; transition: all 0.15s; }
.btn-danger:hover { background: rgba(239,68,68,0.2); }
.edit-search-results { max-height: 280px; overflow-y: auto; margin-bottom: 14px; }
.edit-result-item { padding: 10px 12px; border-radius: 8px; background: var(--surface2); margin-bottom: 6px; cursor: pointer; border: 1px solid transparent; transition: all 0.15s; }
.edit-result-item:hover { border-color: var(--accent); }
.edit-result-item .eri-name { font-size: 13px; font-weight: 600; }
.edit-result-item .eri-sub { font-size: 11px; color: var(--muted2); font-family: 'Space Mono', monospace; margin-top: 2px; }

/* TOAST */
.toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #0a0a0a; padding: 10px 20px; border-radius: 8px; font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; z-index: 9999; opacity: 0; transition: opacity 0.3s, bottom 0.35s cubic-bezier(0.4,0,0.2,1); pointer-events: none; white-space: nowrap; max-width: calc(100vw - 32px); text-align: center; }
.toast.tray-up { bottom: 180px; }
.toast.show { opacity: 1; }
.toast.heart-toast { background: var(--heart); color: #fff; }
.toast.roulette-toast { pointer-events: auto; cursor: pointer; white-space: normal; word-break: break-word; display: flex; align-items: center; gap: 8px; }
.toast.roulette-toast::after { content: 'â†“'; font-size: 14px; flex-shrink: 0; }
.toast.roulette-toast:active { filter: brightness(0.9); }

/* SESSION TRAY */
#sessionTray {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 400;
  background: #0f0f0f;
  border-top: 1px solid var(--border2);
  padding: 0 16px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1), padding 0.35s;
  backdrop-filter: blur(12px);
}
#sessionTray.visible {
  max-height: 320px;
  padding: 14px 16px 20px;
}
.tray-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.tray-title {
  font-family: 'Space Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--muted2);
  display: flex;
  align-items: center;
  gap: 8px;
}
.tray-title .tray-count {
  background: var(--accent);
  color: #0a0a0a;
  font-size: 10px;
  font-weight: 700;
  border-radius: 999px;
  padding: 1px 7px;
  font-family: 'Space Mono', monospace;
}
.tray-actions {
  display: flex;
  gap: 6px;
  align-items: center;
}
.tray-share-btn {
  background: var(--accent);
  color: #0a0a0a;
  border: none;
  border-radius: 7px;
  padding: 7px 14px;
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: opacity 0.15s, transform 0.15s;
}
.tray-share-btn:hover { opacity: 0.85; }
.tray-share-btn:active { transform: scale(0.96); }
.tray-clear-btn {
  background: none;
  border: 1px solid var(--border2);
  border-radius: 7px;
  color: var(--muted2);
  padding: 7px 10px;
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s;
}
.tray-clear-btn:hover { color: #f87171; border-color: #f87171; }
.tray-list {
  display: flex;
  flex-direction: column;
  gap: 5px;
  max-height: 200px;
  overflow-y: auto;
  scrollbar-width: none;
}
.tray-list::-webkit-scrollbar { display: none; }
.tray-item {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 10px;
  animation: traySlideIn 0.22s ease;
  cursor: pointer;
  transition: border-color 0.15s;
}
.tray-item:hover { border-color: var(--border2); }
@keyframes traySlideIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}
.tray-item-num {
  font-family: 'Space Mono', monospace;
  font-size: 10px;
  color: var(--accent);
  flex-shrink: 0;
  min-width: 16px;
}
.tray-item-name {
  flex: 1;
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.tray-item-remove {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 4px;
  font-size: 14px;
  line-height: 1;
  transition: color 0.15s;
  flex-shrink: 0;
}
.tray-item-remove:hover { color: #f87171; }

/* ADD TO SESSION BUTTON */
.add-session-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s;
  flex-shrink: 0;
  color: var(--muted2);
}
.add-session-btn:hover { transform: scale(1.2); color: var(--accent); }
.add-session-btn:active { transform: scale(0.9); }
.add-session-btn svg { width: 18px; height: 18px; transition: all 0.2s; }
.add-session-btn.in-session { color: var(--accent); }
.add-session-btn.in-session svg { filter: drop-shadow(0 0 4px rgba(232,255,71,0.5)); }
@keyframes addPop {
  0%   { transform: scale(1) rotate(0deg); }
  40%  { transform: scale(1.4) rotate(15deg); }
  70%  { transform: scale(0.9) rotate(-5deg); }
  100% { transform: scale(1) rotate(0deg); }
}
.add-session-btn.pop { animation: addPop 0.35s ease forwards; }

/* â”€â”€ VISUAL EXPLORER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#explorerOverlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 300;
  background: #050505;
  flex-direction: column;
  overflow: hidden;
}
#explorerOverlay.open { display: flex; }

.explorer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  height: 56px;
  border-bottom: 1px solid #1a1a1a;
  flex-shrink: 0;
  background: #050505;
  position: relative;
  z-index: 10;
}
.explorer-title {
  font-family: 'Space Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.18em;
  color: #444;
  display: flex;
  align-items: center;
  gap: 8px;
}
.explorer-title::before {
  content: '';
  display: block;
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 8px var(--accent);
  animation: explorerPulse 2s ease-in-out infinite;
}
@keyframes explorerPulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 8px var(--accent); }
  50%       { opacity: 0.4; box-shadow: 0 0 2px var(--accent); }
}
.explorer-back-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  background: none;
  border: 1px solid #222;
  border-radius: 8px;
  color: #666;
  padding: 6px 12px;
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s;
}
.explorer-back-btn:hover { color: var(--text); border-color: #444; }

.explorer-search-wrap {
  flex: 1;
  max-width: 280px;
  position: relative;
  margin: 0 12px;
}
.explorer-search-wrap svg {
  position: absolute;
  left: 9px;
  top: 50%;
  transform: translateY(-50%);
  color: #444;
  width: 14px; height: 14px;
  pointer-events: none;
}
#explorerSearch {
  width: 100%;
  background: #111;
  border: 1px solid #1e1e1e;
  border-radius: 8px;
  padding: 6px 10px 6px 30px;
  color: var(--text);
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  outline: none;
  transition: border-color 0.15s;
}
#explorerSearch:focus { border-color: #333; }
#explorerSearch::placeholder { color: #333; }

/* CANVAS AREA */
.explorer-canvas {
  flex: 1;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* SVG connector lines */
.explorer-lines {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1;
}
.explorer-line {
  stroke: #222;
  stroke-width: 1;
  fill: none;
  stroke-dasharray: 3 7;
  opacity: 0;
  animation: lineReveal 0.5s ease forwards;
}
.explorer-line.regression { stroke: #1e2e28; }
.explorer-line.progression { stroke: #003a5c; }
.explorer-line.variation   { stroke: #3d3200; }
@keyframes lineReveal {
  from { opacity: 0; }
  to   { opacity: 1; }
}

/* NODES */
.explorer-node {
  position: absolute;
  transform: translate(-50%, -50%);
  cursor: pointer;
  z-index: 2;
}

#explorerNodes {
  position: absolute;
  inset: 0;
  pointer-events: none;
}
#explorerNodes .explorer-node {
  pointer-events: auto;
}

/* CENTER NODE */
.center-node {
  width: 170px;
  background: #0d0d0d;
  border: 1.5px solid #282828;
  border-radius: 14px;
  padding: 16px 14px;
  text-align: center;
  box-shadow: 0 0 30px rgba(232,255,71,0.03), 0 0 0 1px rgba(232,255,71,0.05);
  animation: centerAppear 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards;
}
@keyframes centerAppear {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.75); }
  to   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
.center-node .cn-accent-bar {
  height: 2px;
  border-radius: 1px;
  margin: 0 auto 10px;
  width: 32px;
}
.center-node .cn-name {
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  font-weight: 800;
  line-height: 1.35;
  color: var(--text);
  margin-bottom: 8px;
}

.center-node .cn-actions {
  display: flex;
  gap: 6px;
  justify-content: center;
}
.center-node .cn-btn {
  flex: 1;
  padding: 5px 0;
  border-radius: 6px;
  font-family: 'Space Mono', monospace;
  font-size: 9px;
  font-weight: 700;
  cursor: pointer;
  border: none;
  transition: opacity 0.15s;
}
.center-node .cn-btn:hover { opacity: 0.75; }
.center-node .cn-btn.add-btn {
  background: var(--accent);
  color: #0a0a0a;
}
.center-node .cn-btn.add-btn.in-session {
  background: rgba(232,255,71,0.15);
  color: var(--accent);
}
.center-node .cn-btn.fav-btn {
  background: #161616;
  color: #555;
  border: 1px solid #222;
}
.center-node .cn-btn.fav-btn.favorited {
  color: var(--heart);
  border-color: rgba(255,77,109,0.3);
}

/* SATELLITE NODES */
.satellite-node {
  animation: satelliteAppear 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards;
  opacity: 0;
}
@keyframes satelliteAppear {
  from { opacity: 0; transform: translate(-50%, -50%) scale(0.6); }
  to   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
.satellite-node:nth-child(2) { animation-delay: 0.05s; }
.satellite-node:nth-child(3) { animation-delay: 0.1s; }
.satellite-node:nth-child(4) { animation-delay: 0.15s; }
.satellite-node:nth-child(5) { animation-delay: 0.2s; }
.satellite-node:nth-child(6) { animation-delay: 0.25s; }
.satellite-node:nth-child(7) { animation-delay: 0.3s; }

.sat-inner {
  width: 110px;
  height: 84px;
  background: #0d0d0d;
  border: 1px solid #1e1e1e;
  border-radius: 10px;
  padding: 9px 9px 7px;
  text-align: center;
  transition: border-color 0.18s, box-shadow 0.18s, transform 0.18s;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
}
.sat-inner:hover {
  border-color: #2e2e2e;
  transform: scale(1.06);
}
.satellite-node.type-regression .sat-inner:hover { border-color: #2a3830; box-shadow: 0 0 14px rgba(100,160,130,0.08); }
.satellite-node.type-progression .sat-inner:hover { border-color: #003a5c; box-shadow: 0 0 14px rgba(0,191,255,0.12); }
.satellite-node.type-variation .sat-inner:hover   { border-color: #3d3200; box-shadow: 0 0 14px rgba(255,215,0,0.12); }

.sat-inner .sat-type-label {
  font-family: 'Space Mono', monospace;
  font-size: 8px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 5px;
}
.type-regression .sat-type-label { color: #5a9e82; }
.type-progression .sat-type-label { color: #00BFFF; }
.type-variation   .sat-type-label { color: #FFD700; }

.sat-inner .sat-name {
  font-family: 'Syne', sans-serif;
  font-size: 11px;
  font-weight: 700;
  line-height: 1.3;
  color: #ccc;
  word-break: break-word;
  overflow-wrap: break-word;
  width: 100%;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.sat-inner .sat-diff {
  font-family: 'Space Mono', monospace;
  font-size: 9px;
  margin-top: 2px;
  color: #444;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* EMPTY SATELLITE PLACEHOLDER */
.sat-empty .sat-inner {
  border-style: dashed;
  border-color: #191919;
}
.sat-empty .sat-name { color: #333; font-style: italic; font-size: 10px; }


/* EXPLORER SEARCH DROPDOWN */
.explorer-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: #111;
  border: 1px solid #222;
  border-radius: 8px;
  overflow: hidden;
  z-index: 20;
  box-shadow: 0 8px 24px rgba(0,0,0,0.6);
  max-height: 220px;
  overflow-y: auto;
}
.explorer-dropdown-item {
  padding: 8px 12px;
  cursor: pointer;
  transition: background 0.1s;
  border-bottom: 1px solid #1a1a1a;
}
.explorer-dropdown-item:last-child { border-bottom: none; }
.explorer-dropdown-item:hover { background: #1a1a1a; }
.explorer-dropdown-item .edi-name { font-size: 12px; font-weight: 600; color: var(--text); }
.explorer-dropdown-item .edi-sub { font-family: 'Space Mono', monospace; font-size: 9px; color: #555; margin-top: 2px; }

/* EXPLORER TOGGLE BUTTON in header */
.explorer-btn {
  padding: 7px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  border: 1.5px solid #222;
  background: var(--surface);
  color: var(--muted2);
  font-family: 'Syne', sans-serif;
  white-space: nowrap;
  flex-shrink: 0;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  gap: 5px;
}
.explorer-btn:hover { color: var(--text); border-color: #444; }
.explorer-btn.active { background: var(--surface2); color: var(--accent); border-color: var(--accent); }

/* â”€â”€ WHEEL OF GAINS OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#wheelOverlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 600;
  background: rgba(0,0,0,0.96);
  backdrop-filter: blur(12px);
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0;
}
#wheelOverlay.open { display: flex; }

.wheel-header {
  position: absolute;
  top: 0; left: 0; right: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 20px;
  border-bottom: 1px solid #181818;
}
.wheel-title {
  font-family: 'Space Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.22em;
  color: #444;
  display: flex;
  align-items: center;
  gap: 8px;
}
.wheel-title-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 8px var(--accent);
  flex-shrink: 0;
  animation: wdPulse 1.8s ease-in-out infinite;
}
@keyframes wdPulse { 0%,100%{opacity:1;box-shadow:0 0 8px var(--accent)} 50%{opacity:0.3;box-shadow:0 0 2px var(--accent)} }
.wheel-close-btn {
  background: none;
  border: 1px solid #222;
  border-radius: 8px;
  color: #555;
  padding: 6px 12px;
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s;
}
.wheel-close-btn:hover { color: var(--text); border-color: #444; }

/* SLOT MACHINE DRUM */
.wheel-drum-wrap {
  position: relative;
  width: min(420px, 92vw);
  margin-top: 0;
}

/* Top/bottom fade masks */
.wheel-drum-wrap::before,
.wheel-drum-wrap::after {
  content: '';
  position: absolute;
  left: 0; right: 0;
  height: 80px;
  z-index: 3;
  pointer-events: none;
}
.wheel-drum-wrap::before {
  top: 0;
  background: linear-gradient(to bottom, rgba(0,0,0,0.96), transparent);
}
.wheel-drum-wrap::after {
  bottom: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.96), transparent);
}

/* The selector bracket */
.wheel-selector {
  position: absolute;
  top: 50%;
  left: 0; right: 0;
  transform: translateY(-50%);
  height: 72px;
  border-top: 1px solid rgba(232,255,71,0.25);
  border-bottom: 1px solid rgba(232,255,71,0.25);
  z-index: 2;
  pointer-events: none;
}
.wheel-selector::before,
.wheel-selector::after {
  content: '';
  position: absolute;
  top: 50%; transform: translateY(-50%);
  width: 4px; height: 4px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 8px var(--accent);
}
.wheel-selector::before { left: 12px; }
.wheel-selector::after  { right: 12px; }

/* Scrolling drum */
.wheel-drum {
  height: 360px;
  overflow: hidden;
  position: relative;
}
.wheel-drum-inner {
  display: flex;
  flex-direction: column;
  will-change: transform;
}

/* Each slot row */
.wheel-slot {
  height: 72px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  flex-shrink: 0;
  padding: 0 20px;
  text-align: center;
  transition: opacity 0.1s;
}
.wheel-slot-name {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 17px;
  color: #ccc;
  line-height: 1.25;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}
.wheel-slot-diff {
  font-family: 'Space Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: #444;
}

/* Landed state */
.wheel-slot.landed .wheel-slot-name { color: var(--accent); text-shadow: 0 0 20px rgba(232,255,71,0.4); }
.wheel-slot.landed .wheel-slot-diff { color: #888; }

/* RESULT PANEL (shown after landing) */
.wheel-result {
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  margin-top: 24px;
  animation: resultReveal 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards;
}
.wheel-result.show { display: flex; }
@keyframes resultReveal {
  from { opacity:0; transform:translateY(10px) scale(0.95); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}
.wheel-result-label {
  font-family: 'Space Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.18em;
  color: #444;
}
.wheel-result-btns {
  display: flex;
  gap: 10px;
}
.wheel-go-btn {
  padding: 11px 24px;
  background: var(--accent);
  color: #0a0a0a;
  border: none;
  border-radius: 9px;
  font-family: 'Space Mono', monospace;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: opacity 0.15s, transform 0.12s;
  display: flex;
  align-items: center;
  gap: 7px;
}
.wheel-go-btn:hover { opacity: 0.85; }
.wheel-go-btn:active { transform: scale(0.96); }
.wheel-spin-again-btn {
  padding: 11px 18px;
  background: none;
  color: #666;
  border: 1px solid #282828;
  border-radius: 9px;
  font-family: 'Space Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s;
  display: flex;
  align-items: center;
  gap: 7px;
}
.wheel-spin-again-btn:hover { color: var(--text); border-color: #444; }

/* SPIN BUTTON */
.wheel-spin-btn {
  margin-top: 28px;
  padding: 14px 40px;
  background: var(--accent);
  color: #0a0a0a;
  border: none;
  border-radius: 10px;
  font-family: 'Space Mono', monospace;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  letter-spacing: 0.06em;
  transition: opacity 0.15s, transform 0.12s;
  display: flex;
  align-items: center;
  gap: 8px;
}
.wheel-spin-btn:hover { opacity: 0.85; }
.wheel-spin-btn:active { transform: scale(0.96); }
.wheel-spin-btn:disabled { opacity: 0.4; pointer-events: none; }

/* pool size badge */
.wheel-pool-label {
  font-family: 'Space Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: #333;
  margin-top: 12px;
}
.wheel-pool-label strong { color: #555; }

/* HIGHLIGHT FLASH on card */
@keyframes cardGlowFade {
  0%   { box-shadow: 0 0 0 2px var(--accent), 0 0 24px rgba(232,255,71,0.5); border-color: var(--accent); }
  70%  { box-shadow: 0 0 0 2px rgba(232,255,71,0.4), 0 0 12px rgba(232,255,71,0.2); border-color: rgba(232,255,71,0.4); }
  100% { box-shadow: none; border-color: var(--border); }
}
.ex-card.wheel-highlight { animation: cardGlowFade 2.2s ease forwards; }

@media (max-width: 500px) {
  .wheel-slot-name { font-size: 14px; }
  .wheel-drum-wrap { width: 95vw; }
}
  .logo { font-size: 20px; }
  .detail-grid { grid-template-columns: 1fr; }
  .form-row { grid-template-columns: 1fr; }
  .center-node { width: 140px; padding: 12px 10px; }
  .sat-inner { width: 96px; height: 76px; }
  .explorer-search-wrap { display: none; }
}
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
</head>
<body>

<div id="installBanner">
  <div class="bt">
    <strong>Add to Home Screen</strong>
    iOS: tap Share then "Add to Home Screen" Â· Android: tap menu then "Add to Home Screen"
  </div>
  <button onclick="dismissBanner()">Got it</button>
</div>

<button id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="Back to top">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18 15 12 9 6 15"/></svg>
</button>

<div class="toast" id="toast"></div>

<div id="editModeBar">
  <div class="em-label">
    <div class="em-dot"></div>
    EDIT MODE ACTIVE
  </div>
  <button class="em-exit" onclick="exitEditMode()">âœ• Exit Edit Mode</button>
</div>

<header>
  <div class="header-top">
    <div class="logo" id="logoBtn">Wilde<span>.</span></div>
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="search" id="searchInput" placeholder="Search exercises..." autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
    <button class="filter-toggle-btn" id="filterToggleBtn" onclick="toggleFilterDrawer()" title="Toggle filters">
      <span class="filter-dot"></span>
      Filters
    </button>
    <button class="explorer-btn" id="explorerBtn" onclick="openExplorer()" title="Visual Explorer">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><circle cx="4" cy="6" r="2"/><circle cx="20" cy="6" r="2"/><circle cx="4" cy="18" r="2"/><circle cx="20" cy="18" r="2"/><line x1="6" y1="6" x2="10" y2="10"/><line x1="18" y1="6" x2="14" y2="10"/><line x1="6" y1="18" x2="10" y2="14"/><line x1="18" y1="18" x2="14" y2="14"/></svg>
      Map
    </button>
  </div>
</header>

<div id="filterDrawer">
  <div class="filter-section">

    <div class="filter-label">Muscle</div>
    <div class="filter-row" id="muscleRow"></div>
    <div class="filter-label">Difficulty</div>
    <div class="filter-row" id="diffRow">
      <div class="pill active" onclick="setDiff('all',this)">All</div>
      <div class="pill diff-novice" onclick="setDiff('Novice',this)">Novice</div>
      <div class="pill diff-beginner" onclick="setDiff('Beginner',this)">Beginner</div>
      <div class="pill diff-intermediate" onclick="setDiff('Intermediate',this)">Intermediate</div>
      <div class="pill diff-advanced" onclick="setDiff('Advanced',this)">Advanced</div>
      <div class="pill diff-expert" onclick="setDiff('Expert',this)">Expert</div>
      <div class="pill diff-master" onclick="setDiff('Master',this)">Master</div>
      <div class="pill fav-pill" id="favPill" onclick="toggleFavFilter(this)">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" fill="none">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
        Saved
      </div>
    </div>

  </div>
</div>

<div class="results-bar">
  <div class="results-count">Showing <strong id="countDisplay">0</strong> exercises</div>
  <button class="roulette-btn" id="rouletteBtn" onclick="exerciseRoulette()" title="Pick a random exercise">ðŸŽ²</button>
  <select class="sort-select" id="sortSelect" onchange="render()">
    <option value="default">Sort: Default</option>
    <option value="az">A â†’ Z</option>
    <option value="za">Z â†’ A</option>
    <option value="diff-asc">Easiest first</option>
    <option value="diff-desc">Hardest first</option>
  </select>
</div>

<div id="listContainer">
  <div class="loading-state"><div class="spinner"></div>Loading exercises...</div>
</div>

<!-- PIN MODAL -->
<div id="pinModal">
  <div class="pin-box">
    <h3>Enter Password</h3>
    <p>This area is restricted</p>
    <input type="password" id="pinInput" placeholder="Password" onkeydown="if(event.key==='Enter')checkPin()">
    <button class="pin-btn" onclick="checkPin()">Unlock</button>
    <button class="pin-cancel" onclick="closePinModal()">Cancel</button>
  </div>
</div>

<!-- EDIT PANEL -->
<div id="editPanel">
  <div class="edit-panel-inner">
    <div class="edit-panel-header">
      <h2>Edit <span>Mode</span></h2>
      <button class="close-btn" onclick="closeEdit()">Ã—</button>
    </div>
    <div class="edit-mode-tabs">
      <div class="mode-tab active" onclick="switchEditTab('add',this)">+ Add New</div>
      <div class="mode-tab" onclick="switchEditTab('edit',this)">Edit</div>
      <div class="mode-tab" onclick="switchEditTab('delete',this)">Delete</div>
    </div>
    <div id="editTabContent"></div>
  </div>
</div>

<!-- VISUAL EXPLORER OVERLAY -->
<div id="explorerOverlay">
  <div class="explorer-header">
    <button class="explorer-back-btn" onclick="closeExplorer()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      Back
    </button>
    <div class="explorer-search-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="search" id="explorerSearch" placeholder="Jump to exercise..." autocomplete="off" spellcheck="false">
      <div class="explorer-dropdown" id="explorerDropdown" style="display:none"></div>
    </div>
    <div class="explorer-title">Visual Map</div>
  </div>

  <div class="explorer-canvas" id="explorerCanvas">
    <svg class="explorer-lines" id="explorerLines"></svg>
    <div id="explorerNodes"></div>
  </div>


</div>

<!-- WHEEL OF GAINS OVERLAY -->
<div id="wheelOverlay">
  <div class="wheel-header">
    <div class="wheel-title">
      <div class="wheel-title-dot"></div>
      The Wheel of Gains
    </div>
    <button class="wheel-close-btn" onclick="closeWheel()">âœ• Close</button>
  </div>

  <div class="wheel-drum-wrap">
    <div class="wheel-selector"></div>
    <div class="wheel-drum" id="wheelDrum">
      <div class="wheel-drum-inner" id="wheelDrumInner"></div>
    </div>
  </div>

  <button class="wheel-spin-btn" id="wheelSpinBtn" onclick="spinWheel()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
    SPIN
  </button>

  <div class="wheel-result" id="wheelResult">
    <div class="wheel-result-label">Your exercise awaits â€”</div>
    <div class="wheel-result-btns">
      <button class="wheel-go-btn" id="wheelGoBtn" onclick="wheelGo()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        Go to Exercise
      </button>
      <button class="wheel-spin-again-btn" onclick="wheelSpinAgain()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        Spin Again
      </button>
    </div>
  </div>

  <div class="wheel-pool-label" id="wheelPoolLabel"></div>
</div>

<!-- SESSION TRAY -->
<div id="sessionTray">
  <div class="tray-header">
    <div class="tray-title">
      Session
      <span class="tray-count" id="trayCount">0</span>
    </div>
    <div class="tray-actions">
      <button class="tray-clear-btn" onclick="clearSession()">Clear</button>
      <button class="tray-share-btn" onclick="shareSession()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
        Share
      </button>
    </div>
  </div>
  <div class="tray-list" id="trayList"></div>
</div>

<script>
const SUPABASE_URL = 'https://spwoicclxqoxqkfkmcrw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwd29pY2NseHFveHFrZmttY3J3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MzIzNDMsImV4cCI6MjA4NzIwODM0M30.QhrV6CqGMVpCu_ySygeATvF_hvGoGmgYzbocp9A-qX0';
const PASSWORD = 'Wilde';

// â”€â”€ Anonymous user identity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// A random UUID is generated on first visit and persisted in localStorage.
// This scopes favorites to the device without requiring any login.
function getOrCreateUserId() {
  let uid = localStorage.getItem('wilde_uid');
  if (!uid) {
    uid = crypto.randomUUID ? crypto.randomUUID() : 'uid-' + Math.random().toString(36).slice(2) + Date.now();
    localStorage.setItem('wilde_uid', uid);
  }
  return uid;
}
const USER_ID = getOrCreateUserId();

const MUSCLE_REGIONS = {
  upper: ['Chest','Back','Shoulders','Trapezius','Biceps','Triceps','Forearms'],
  core:  ['Core'],
  lower: ['Quads','Hamstrings','Glutes','Calves','Hip Flexors','Abductors','Adductors','Shins'],
};
const MUSCLE_COLORS = {
  Chest:'#60a5fa', Back:'#3b82f6', Shoulders:'#93c5fd', Traps:'#7dd3fc',
  Biceps:'#a5b4fc', Triceps:'#818cf8', Forearms:'#c4b5fd', Core:'#34d399',
  Quads:'#f472b6', Hamstrings:'#fb7185', Glutes:'#f43f5e', Calves:'#fda4af',
  Hips:'#fb923c', 'Ankles/Feet':'#facc15',
};
const DIFF_ORDER = ['Novice','Beginner','Intermediate','Advanced','Expert','Master','Legendary','Grand Master'];
const MUSCLES_LIST = ['Ankles/Feet','Back','Biceps','Calves','Chest','Core','Forearms','Glutes','Hamstrings','Hips','Quads','Shoulders','Traps','Triceps'];
const DIFFS_LIST = ['Novice','Beginner','Intermediate','Advanced','Expert','Master','Legendary','Grand Master'];

async function sbFetch(path, opts={}) {
  const res = await fetch(SUPABASE_URL + '/rest/v1/' + path, {
    ...opts,
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': 'Bearer ' + SUPABASE_KEY,
      'Content-Type': 'application/json',
      'Prefer': opts.prefer || 'return=minimal',
      ...(opts.headers||{})
    }
  });
  if (opts.returnData) return res.json();
  return res;
}

let exercises = [];
let favoriteIds = new Set();   // exercise IDs that are favorited by this user
let sessionList = [];          // workout stacking: array of {id, name, video}
let currentRegion = 'all';
let currentMuscle = 'all';
let currentDiff = 'all';
let currentSearch = '';
let showFavoritesOnly = false;
let displayCount = 40;
let expandedId = null;
let logoTaps = 0;
let logoTimer = null;
let filterDrawerOpen = false;

// FILTER DRAWER
function toggleFilterDrawer() {
  filterDrawerOpen = !filterDrawerOpen;
  const drawer = document.getElementById('filterDrawer');
  const btn = document.getElementById('filterToggleBtn');
  drawer.classList.toggle('open', filterDrawerOpen);
  btn.classList.toggle('active', filterDrawerOpen);
}

function updateFilterToggleState() {
  const btn = document.getElementById('filterToggleBtn');
  if (!btn) return;
  const hasActive = currentRegion !== 'all' || currentMuscle !== 'all' || currentDiff !== 'all' || showFavoritesOnly;
  btn.classList.toggle('has-filters', hasActive);
}

// â”€â”€ Load all exercises from Supabase (paginated) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadExercises() {
  try {
    let all = [];
    let from = 0;
    const pageSize = 1000;
    while (true) {
      const res = await fetch(SUPABASE_URL + '/rest/v1/exercises?select=*&order=id.asc&limit=' + pageSize + '&offset=' + from, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY, 'Prefer': 'count=none' }
      });
      const batch = await res.json();
      if (!batch || batch.length === 0) break;
      all = all.concat(batch);
      if (batch.length < pageSize) break;
      from += pageSize;
    }
    exercises = all;
    // Randomize default order on every load for fresh discovery
    exercises = exercises.sort(() => Math.random() - 0.5);
    buildMusclePills('all');
    // Load favorites in parallel, then render once both are done
    await loadFavorites();
    render();
  } catch(e) {
    document.getElementById('listContainer').innerHTML = '<div class="empty-state"><div class="big">âš ï¸</div>Could not load exercises.<br>Check your connection.</div>';
  }
}

// â”€â”€ Favorites: load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFavorites() {
  try {
    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/favorites?select=exercise_id&user_id=eq.${encodeURIComponent(USER_ID)}`,
      { headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY } }
    );
    const rows = await res.json();
    favoriteIds = new Set((rows || []).map(r => r.exercise_id));
  } catch(e) {
    // Silently fail â€” favorites just won't show on this load
    favoriteIds = new Set();
  }
}

// â”€â”€ Favorites: toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleFavorite(exerciseId, event) {
  // Stop the click from also toggling the card expand
  event.stopPropagation();

  const isFav = favoriteIds.has(exerciseId);

  // Optimistic UI update
  if (isFav) {
    favoriteIds.delete(exerciseId);
  } else {
    favoriteIds.add(exerciseId);
  }

  // Animate the button immediately
  const btn = event.currentTarget;
  btn.classList.toggle('favorited', !isFav);
  btn.classList.add('pop');
  btn.addEventListener('animationend', () => btn.classList.remove('pop'), { once: true });

  // Show toast
  showToast(isFav ? 'Removed from favorites' : 'â™¥ Added to favorites', isFav ? false : true);

  // If we're viewing favorites-only and un-favoriting, re-render to remove the card
  if (showFavoritesOnly && isFav) render();

  // Sync to Supabase
  try {
    if (isFav) {
      await sbFetch(
        `favorites?user_id=eq.${encodeURIComponent(USER_ID)}&exercise_id=eq.${exerciseId}`,
        { method: 'DELETE' }
      );
    } else {
      await sbFetch('favorites', {
        method: 'POST',
        body: JSON.stringify({ user_id: USER_ID, exercise_id: exerciseId }),
        prefer: 'return=minimal'
      });
    }
  } catch(e) {
    // Rollback optimistic update on error
    if (isFav) favoriteIds.add(exerciseId); else favoriteIds.delete(exerciseId);
    btn.classList.toggle('favorited', isFav);
    showToast('Error saving â€” try again');
  }
}

// â”€â”€ Favorites: filter pill toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFavFilter(el) {
  showFavoritesOnly = !showFavoritesOnly;
  el.classList.toggle('active', showFavoritesOnly);
  displayCount = 40;
  updateFilterToggleState();
  render();
}

// INSTALL BANNER
function dismissBanner() {
  document.getElementById('installBanner').classList.remove('show');
  localStorage.setItem('wilde_banner','1');
}
if (!localStorage.getItem('wilde_banner')) {
  setTimeout(()=>document.getElementById('installBanner').classList.add('show'), 2000);
}

// LOGO TAP (5 taps = password prompt)
document.getElementById('logoBtn').addEventListener('click', () => {
  logoTaps++;
  clearTimeout(logoTimer);
  if (logoTaps >= 5) { logoTaps = 0; openPinModal(); return; }
  logoTimer = setTimeout(()=>{ logoTaps = 0; }, 1500);
});

// PIN MODAL
function openPinModal() {
  document.getElementById('pinModal').classList.add('open');
  setTimeout(()=>document.getElementById('pinInput').focus(), 100);
}
function closePinModal() {
  document.getElementById('pinModal').classList.remove('open');
  document.getElementById('pinInput').value = '';
}
function checkPin() {
  const val = document.getElementById('pinInput').value;
  if (val === PASSWORD) {
    closePinModal();
    openEdit();
  } else {
    const inp = document.getElementById('pinInput');
    inp.classList.add('error');
    inp.value = '';
    setTimeout(()=>inp.classList.remove('error'), 400);
  }
}

// MUSCLE PILLS
function buildMusclePills(region) {
  const row = document.getElementById('muscleRow');
  let muscles = MUSCLES_LIST;
  if (region !== 'all') muscles = muscles.filter(m => MUSCLE_REGIONS[region]?.includes(m));
  row.innerHTML = `<div class="pill active" onclick="setMuscle('all',this)">All</div>` +
    muscles.map(m=>`<div class="pill" onclick="setMuscle('${m}',this)">${m}</div>`).join('');
}

// FILTERS
function setRegion(r, el) {
  currentRegion = r; currentMuscle = 'all'; displayCount = 40;
  document.querySelectorAll('#regionRow .pill').forEach(p=>p.classList.remove('active')); el.classList.add('active');
  buildMusclePills(r); updateFilterToggleState(); render();
}
function setMuscle(m, el) {
  currentMuscle = m; displayCount = 40;
  document.querySelectorAll('#muscleRow .pill').forEach(p=>p.classList.remove('active')); el.classList.add('active'); updateFilterToggleState(); render();
}
function setDiff(d, el) {
  currentDiff = d; displayCount = 40;
  document.querySelectorAll('#diffRow .pill').forEach(p=>p.classList.remove('active')); el.classList.add('active'); updateFilterToggleState(); render();
}
document.getElementById('searchInput').addEventListener('input', e => {
  currentSearch = e.target.value.trim().toLowerCase(); displayCount = 40; render();
});

// FILTER + SORT
function getFiltered() {
  let list = exercises;
  if (showFavoritesOnly) list = list.filter(e => favoriteIds.has(e.id));
  if (currentRegion !== 'all') list = list.filter(e => MUSCLE_REGIONS[currentRegion]?.includes(e.m));
  if (currentMuscle !== 'all') list = list.filter(e => e.m === currentMuscle);
  if (currentDiff !== 'all') list = list.filter(e => e.d === currentDiff);
  if (currentSearch) list = list.filter(e =>
    (e.n||'').toLowerCase().includes(currentSearch) ||
    (e.m||'').toLowerCase().includes(currentSearch) ||
    (e.s||'').toLowerCase().includes(currentSearch) ||
    (e.e||'').toLowerCase().includes(currentSearch) ||
    (e.mv||'').toLowerCase().includes(currentSearch)
  );
  const sort = document.getElementById('sortSelect').value;
  if (sort==='az') list = [...list].sort((a,b)=>(a.n||'').localeCompare(b.n||''));
  if (sort==='za') list = [...list].sort((a,b)=>(b.n||'').localeCompare(a.n||''));
  if (sort==='diff-asc') list = [...list].sort((a,b)=>DIFF_ORDER.indexOf(a.d)-DIFF_ORDER.indexOf(b.d));
  if (sort==='diff-desc') list = [...list].sort((a,b)=>DIFF_ORDER.indexOf(b.d)-DIFF_ORDER.indexOf(a.d));
  return list;
}

// RENDER
function render() {
  const filtered = getFiltered();
  const shown = filtered.slice(0, displayCount);
  document.getElementById('countDisplay').textContent = filtered.length.toLocaleString();
  const container = document.getElementById('listContainer');
  if (filtered.length === 0) {
    const emptyMsg = showFavoritesOnly
      ? `<div class="empty-state"><div class="big">â™¡</div>No favorites yet.<br>Tap the heart on any exercise to save it.</div>`
      : `<div class="empty-state"><div class="big">ðŸ”</div>No exercises found.</div>`;
    container.innerHTML = emptyMsg;
    return;
  }
  container.innerHTML = shown.map(ex => renderCard(ex)).join('') +
    (filtered.length > displayCount ? `<button class="load-more-btn" onclick="loadMore()">${filtered.length - displayCount} more exercises â€” tap to load</button>` : '');
}

// Heart SVG helper
function heartSVG() {
  return `<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
  </svg>`;
}

// â”€â”€ Anatomical Muscle Diagram â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Polygon data sourced from react-body-highlighter (MIT licence, GV79 / HichamELBSI).
// viewBox "0 0 100 200". Each entry: { slugs: [...db-values], points: [...polygon-point-strings] }
// slugs are the Supabase `m` values that map to this muscle group.
// We mark every polygon whose slugs include `primaryMuscle` with class "hi".

const FRONT_MUSCLES = [
  { slugs: ['Chest'],     points: ['51.8367347 41.6326531 51.0204082 55.1020408 57.9591837 57.9591837 67.755102 55.5102041 70.6122449 47.3469388 62.0408163 41.6326531','29.7959184 46.5306122 31.4285714 55.5102041 40.8163265 57.9591837 48.1632653 55.1020408 47.755102 42.0408163 37.5510204 42.0408163'] },
  { slugs: ['Core'],      points: ['56.3265306 59.1836735 57.9591837 64.0816327 58.3673469 77.9591837 58.3673469 92.6530612 56.3265306 98.3673469 55.1020408 104.081633 51.4285714 107.755102 51.0204082 84.4897959 50.6122449 67.3469388 51.0204082 57.1428571','43.6734694 58.7755102 48.5714286 57.1428571 48.9795918 67.3469388 48.5714286 84.4897959 48.1632653 107.346939 44.4897959 103.673469 40.8163265 91.4285714 40.8163265 78.3673469 41.2244898 64.4897959','68.5714286 63.2653061 67.3469388 57.1428571 58.7755102 59.5918367 60 64.0816327 60.4081633 83.2653061 65.7142857 78.7755102 66.5306122 69.7959184','33.877551 78.3673469 33.0612245 71.8367347 31.0204082 63.2653061 32.244898 57.1428571 40.8163265 59.1836735 39.1836735 63.2653061 39.1836735 83.6734694'] },
  { slugs: ['Biceps'],    points: ['16.7346939 68.1632653 17.9591837 71.4285714 22.8571429 66.122449 28.9795918 53.877551 27.755102 49.3877551 20.4081633 55.9183673','71.4285714 49.3877551 70.2040816 54.6938776 76.3265306 66.122449 81.6326531 71.8367347 82.8571429 68.9795918 78.7755102 55.5102041'] },
  { slugs: ['Triceps'],   points: ['69.3877551 55.5102041 69.3877551 61.6326531 75.9183673 72.6530612 77.5510204 70.2040816 75.5102041 67.3469388','22.4489796 69.3877551 29.7959184 55.5102041 29.7959184 60.8163265 22.8571429 73.0612245'] },
  { slugs: ['Forearms'],  points: ['6.12244898 88.5714286 10.2040816 75.1020408 14.6938776 70.2040816 16.3265306 74.2857143 19.1836735 73.4693878 4.48979592 97.5510204 0 100','84.4897959 69.7959184 83.2653061 73.4693878 80 73.0612245 95.1020408 98.3673469 100 100.408163 93.4693878 89.3877551 89.7959184 76.3265306','77.5510204 72.244898 77.5510204 77.5510204 80.4081633 84.0816327 85.3061224 89.7959184 92.244898 101.22449 94.6938776 99.5918367','6.93877551 101.22449 13.4693878 90.6122449 18.7755102 84.0816327 21.6326531 77.1428571 21.2244898 71.8367347 4.89795918 98.7755102'] },
  { slugs: ['Shoulders'], points: ['78.3673469 53.0612245 79.5918367 47.755102 79.1836735 41.2244898 75.9183673 37.9591837 71.0204082 36.3265306 72.244898 42.8571429 71.4285714 47.3469388','28.1632653 47.3469388 21.2244898 53.0612245 20 47.755102 20.4081633 40.8163265 24.4897959 37.1428571 28.5714286 37.1428571 26.9387755 43.2653061'] },
  { slugs: ['Quads'],     points: ['34.6938776 98.7755102 37.1428571 108.163265 37.1428571 127.755102 34.2857143 137.142857 31.0204082 132.653061 29.3877551 120 28.1632653 111.428571 29.3877551 100.816327 32.244898 94.6938776','63.2653061 105.714286 64.4897959 100 66.9387755 94.6938776 70.2040816 101.22449 71.0204082 111.836735 68.1632653 133.061224 65.3061224 137.55102 62.4489796 128.571429 62.0408163 111.428571','38.7755102 129.387755 38.3673469 112.244898 41.2244898 118.367347 44.4897959 129.387755 42.8571429 135.102041 40 146.122449 36.3265306 146.530612 35.5102041 140','59.5918367 145.714286 55.5102041 128.979592 60.8163265 113.877551 61.2244898 130.204082 64.0816327 139.591837 62.8571429 146.530612','32.6530612 138.367347 26.5306122 145.714286 25.7142857 136.734694 25.7142857 127.346939 26.9387755 114.285714 29.3877551 133.469388','71.8367347 113.061224 73.877551 124.081633 73.877551 140.408163 72.6530612 145.714286 66.5306122 138.367347 70.2040816 133.469388'] },
  { slugs: ['Adductors'], points: ['52.6530612 110.204082 54.2857143 124.897959 60 110.204082 62.0408163 100 64.8979592 94.2857143 60 92.6530612 56.7346939 104.489796','47.755102 110.612245 44.8979592 125.306122 42.0408163 115.918367 40.4081633 113.061224 39.5918367 107.346939 37.9591837 102.44898 34.6938776 93.877551 39.5918367 92.244898 41.6326531 99.1836735 43.6734694 105.306122'] },
  { slugs: ['Calves'],    points: ['71.4285714 160.408163 73.4693878 153.469388 76.7346939 161.22449 79.5918367 167.755102 78.3673469 187.755102 79.5918367 195.510204 74.6938776 195.510204','24.8979592 194.693878 27.755102 164.897959 28.1632653 160.408163 26.122449 154.285714 24.8979592 157.55102 22.4489796 161.632653 20.8163265 167.755102 22.0408163 188.163265 20.8163265 195.510204','72.6530612 195.102041 69.7959184 159.183673 65.3061224 158.367347 64.0816327 162.44898 64.0816327 165.306122 65.7142857 177.142857','35.5102041 158.367347 35.9183673 162.44898 35.9183673 166.938776 35.1020408 172.244898 35.1020408 176.734694 32.244898 182.040816 30.6122449 187.346939 26.9387755 194.693878 27.3469388 187.755102 28.1632653 180.408163 28.5714286 175.510204 28.9795918 169.795918 29.7959184 164.081633 30.2040816 158.77551'] },
  // Abductors: outer-thigh polygons from anterior data (Abductors slug = 'abductors')
  { slugs: ['Abductors'], points: ['52.6530612 110.204082 54.2857143 124.897959 60 110.204082 62.0408163 100 64.8979592 94.2857143 60 92.6530612 56.7346939 104.489796','47.755102 110.612245 44.8979592 125.306122 42.0408163 115.918367 40.4081633 113.061224 39.5918367 107.346939 37.9591837 102.44898 34.6938776 93.877551 39.5918367 92.244898 41.6326531 99.1836735 43.6734694 105.306122'] },
  // Hip Flexors share the abductor / upper-quad region â€” re-use the front-deltoid neck/hip area
  { slugs: ['Hip Flexors'], points: ['51.0204082 107.755102 51.0204082 84.4897959 50.6122449 67.3469388 51.0204082 57.1428571 48.5714286 57.1428571 48.9795918 67.3469388 48.5714286 84.4897959 48.1632653 107.346939'] },
  // Shins: the tibialis anterior area, between knee and ankle on the front
  { slugs: ['Shins'],     points: ['35.5102041 158.367347 35.9183673 162.44898 35.9183673 166.938776 35.1020408 172.244898 35.1020408 176.734694 32.244898 182.040816 30.6122449 187.346939 26.9387755 194.693878 27.3469388 187.755102 28.1632653 180.408163 28.5714286 175.510204 28.9795918 169.795918 29.7959184 164.081633 30.2040816 158.77551','72.6530612 195.102041 69.7959184 159.183673 65.3061224 158.367347 64.0816327 162.44898 64.0816327 165.306122 65.7142857 177.142857'] },
];

const BACK_MUSCLES = [
  { slugs: ['Trapezius'],  points: ['44.6808511 21.7021277 47.6595745 21.7021277 47.2340426 38.2978723 47.6595745 64.6808511 38.2978723 53.1914894 35.3191489 40.8510638 31.0638298 36.5957447 39.1489362 33.1914894 43.8297872 27.2340426','52.3404255 21.7021277 55.7446809 21.7021277 56.5957447 27.2340426 60.8510638 32.7659574 68.9361702 36.5957447 64.6808511 40.4255319 61.7021277 53.1914894 52.3404255 64.6808511 53.1914894 38.2978723'] },
  { slugs: ['Back'],       points: ['31.0638298 38.7234043 28.0851064 48.9361702 28.5106383 55.3191489 34.0425532 75.3191489 47.2340426 71.0638298 47.2340426 66.3829787 36.5957447 54.0425532 33.6170213 41.2765957','68.9361702 38.7234043 71.9148936 49.3617021 71.4893617 56.1702128 65.9574468 75.3191489 52.7659574 71.0638298 52.7659574 66.3829787 63.4042553 54.4680851 66.3829787 41.7021277','47.6595745 72.7659574 34.4680851 77.0212766 35.3191489 83.4042553 49.3617021 102.12766 46.8085106 82.9787234','52.3404255 72.7659574 65.5319149 77.0212766 64.6808511 83.4042553 50.6382979 102.12766 53.1914894 83.8297872'] },
  { slugs: ['Shoulders'],  points: ['29.3617021 37.0212766 22.9787234 39.1489362 17.4468085 44.2553191 18.2978723 53.6170213 24.2553191 49.3617021 27.2340426 46.3829787','71.0638298 37.0212766 78.2978723 39.5744681 82.5531915 44.6808511 81.7021277 53.6170213 74.893617 48.9361702 72.3404255 45.106383'] },
  { slugs: ['Triceps'],    points: ['26.8085106 49.787234 17.8723404 55.7446809 14.4680851 72.3404255 16.5957447 81.7021277 21.7021277 63.8297872 26.8085106 55.7446809','73.6170213 50.212766 82.1276596 55.7446809 85.9574468 73.1914894 83.4042553 82.1276596 77.8723404 62.9787234 73.1914894 55.7446809','26.8085106 58.2978723 26.8085106 68.5106383 22.9787234 75.3191489 19.1489362 77.4468085 22.5531915 65.5319149','72.7659574 58.2978723 77.0212766 64.6808511 80.4255319 77.4468085 76.5957447 75.3191489 72.7659574 68.9361702'] },
  { slugs: ['Forearms'],   points: ['86.3829787 75.7446809 91.0638298 83.4042553 93.1914894 94.0425532 100 106.382979 96.1702128 104.255319 88.0851064 89.3617021 84.2553191 83.8297872','13.6170213 75.7446809 8.93617021 83.8297872 6.80851064 93.6170213 0 106.382979 3.82978723 104.255319 12.3404255 88.5106383 15.7446809 82.9787234','81.2765957 79.5744681 77.4468085 77.8723404 79.1489362 84.6808511 91.0638298 103.829787 93.1914894 108.93617 94.4680851 104.680851','18.7234043 79.5744681 22.1276596 77.8723404 20.8510638 84.2553191 9.36170213 102.978723 6.80851064 108.510638 5.10638298 104.680851'] },
  { slugs: ['Glutes'],     points: ['44.6808511 99.5744681 30.212766 108.510638 29.787234 118.723404 31.4893617 125.957447 47.2340426 121.276596 49.3617021 114.893617','55.3191489 99.1489362 51.0638298 114.468085 52.3404255 120.851064 68.0851064 125.957447 69.787234 119.148936 69.3617021 108.510638','48.0851064 122.978723 44.6808511 122.978723 41.2765957 125.531915 45.106383 144.255319 48.5106383 135.744681 48.9361702 129.361702','51.9148936 122.553191 55.7446809 123.404255 59.1489362 125.957447 54.893617 144.255319 51.9148936 136.170213 51.0638298 129.361702'] },
  { slugs: ['Hamstrings'], points: ['28.9361702 122.12766 31.0638298 129.361702 36.5957447 125.957447 35.3191489 135.319149 34.4680851 150.212766 29.3617021 158.297872 28.9361702 146.808511 27.6595745 141.276596 27.2340426 131.489362','71.4893617 121.702128 69.3617021 128.93617 63.8297872 125.957447 65.5319149 136.595745 66.3829787 150.212766 71.0638298 158.297872 71.4893617 147.659574 72.7659574 142.12766 73.6170213 131.914894','38.7234043 125.531915 44.2553191 145.957447 40.4255319 166.808511 36.1702128 152.765957 37.0212766 135.319149','61.7021277 125.531915 63.4042553 136.170213 64.2553191 153.191489 60 166.808511 56.1702128 146.382979'] },
  { slugs: ['Calves'],     points: ['29.3617021 160.425532 28.5106383 167.234043 24.6808511 179.574468 23.8297872 192.765957 25.5319149 197.021277 28.5106383 193.191489 29.787234 180 31.9148936 171.06383 31.9148936 166.808511','37.4468085 165.106383 35.3191489 167.659574 33.1914894 171.914894 31.0638298 180.425532 30.212766 191.914894 34.0425532 200 38.7234043 190.638298 39.1489362 168.93617','62.9787234 165.106383 61.2765957 168.510638 61.7021277 190.638298 66.3829787 199.574468 70.6382979 191.914894 68.9361702 179.574468 66.8085106 170.212766','70.6382979 160.425532 72.3404255 168.510638 75.7446809 179.148936 76.5957447 192.765957 74.4680851 196.595745 72.3404255 193.617021 70.6382979 179.574468 68.0851064 168.085106'] },
];

function muscleDiagramSVG(primaryMuscle) {
  const m = primaryMuscle || '';

  // Which view(s) contain this muscle?
  const backSlugs = new Set(['Back','Trapezius','Triceps','Glutes','Hamstrings','Calves']);
  const isFrontPrimary = !backSlugs.has(m);
  const isBackPrimary  =  backSlugs.has(m);

  // Build a polygon tag: highlight if this entry's slugs include m
  function polys(list) {
    return list.map(entry => {
      const active = entry.slugs.includes(m);
      return entry.points.map(pts =>
        `<polygon points="${pts}"${active ? ' class="hi"' : ''}/>` 
      ).join('');
    }).join('');
  }

  const frontSVG = `<svg class="body-svg" viewBox="0 0 100 200" xmlns="http://www.w3.org/2000/svg">${polys(FRONT_MUSCLES)}</svg>`;
  const backSVG  = `<svg class="body-svg" viewBox="0 0 100 200" xmlns="http://www.w3.org/2000/svg">${polys(BACK_MUSCLES)}</svg>`;

  return `<div class="muscle-diagram-wrap">
    <div class="diagram-col${isFrontPrimary ? '' : ' dim'}">${frontSVG}<span class="diagram-label">Front</span></div>
    <div class="diagram-divider"></div>
    <div class="diagram-col${isBackPrimary  ? '' : ' dim'}">${backSVG}<span class="diagram-label">Back</span></div>
  </div>`;
}



// Build 2x2 stat grid for expanded card detail
function buildStatGrid(ex) {
  const equipDisplay = ex.e && ex.e !== 'BW' ? ex.e : 'Bodyweight';
  const cells = [
    { label: 'Primary Muscle', value: ex.m || null, pos: 'tl' },
    { label: 'Secondary Muscle', value: ex.s || null, pos: 'tr' },
    { label: 'Equipment', value: equipDisplay, pos: 'bl' },
    { label: 'Movement Pattern', value: ex.mv || null, pos: 'br' },
  ].filter(c => c.value);

  // If we only have 1 or 2 items, make them full width
  const isWide = cells.length <= 2;
  return cells.map(c =>
    `<div class="detail-item${isWide ? ' full' : ''}"><label>${c.label}</label><p>${c.value}</p></div>`
  ).join('');
}

function renderCard(ex) {
  const color = MUSCLE_COLORS[ex.m] || '#888';
  const diffClass = (ex.d||'').toLowerCase().replace(' ','');
  const isExpanded = expandedId === ex.id;
  const isFav = favoriteIds.has(ex.id);
  const equipDisplay = ex.e && ex.e !== 'BW' ? ex.e : 'Bodyweight';
  let detailHtml = '';
  if (isExpanded && editModeActive) {
    // EDIT MODE: inline editable fields
    detailHtml = `<div class="ex-detail edit-mode-detail" onclick="event.stopPropagation()">
      <div class="inline-edit-grid">
        <div class="inline-field full"><label>Name</label><input id="ie_name_${ex.id}" value="${(ex.n||'').replace(/"/g,'&quot;')}"></div>
        <div class="inline-field"><label>Primary Muscle</label><select id="ie_muscle_${ex.id}">${MUSCLES_LIST.map(m=>`<option${ex.m===m?' selected':''}>${m}</option>`).join('')}</select></div>
        <div class="inline-field"><label>Difficulty</label><select id="ie_diff_${ex.id}">${DIFFS_LIST.map(d=>`<option${ex.d===d?' selected':''}>${d}</option>`).join('')}</select></div>
        <div class="inline-field"><label>Equipment</label><input id="ie_equip_${ex.id}" value="${(ex.e||'').replace(/"/g,'&quot;')}"></div>
        <div class="inline-field"><label>Secondary Muscle</label><input id="ie_sec_${ex.id}" value="${(ex.s||'').replace(/"/g,'&quot;')}"></div>
        <div class="inline-field full"><label>Movement Pattern</label><input id="ie_mv_${ex.id}" value="${(ex.mv||'').replace(/"/g,'&quot;')}"></div>
        <div class="inline-field full"><label>YouTube URL</label><input id="ie_video_${ex.id}" value="${(ex.v||'').replace(/"/g,'&quot;')}"></div>
      </div>
      <div class="inline-edit-actions">
        <button class="inline-save-btn" onclick="inlineSaveEdit(${ex.id})">Save Changes</button>
        <button class="inline-delete-btn" onclick="inlineDeleteExercise(${ex.id})">Delete</button>
      </div>
    </div>`;
  } else if (isExpanded) {
    detailHtml = `<div class="ex-detail">
      <div class="detail-grid">
        ${buildStatGrid(ex)}
        ${ex.c?`<div class="detail-item full"><label>Classification</label><p>${ex.c}</p></div>`:''}
        ${muscleDiagramSVG(ex.m)}
      </div>
      ${(()=>{
        const vUrl = ex.v || `https://www.youtube.com/results?search_query=${encodeURIComponent((ex.n||'exercise')+' exercise how to form')}`;
        const isSearch = !ex.v;
        return `<a class="video-btn" href="${vUrl}" target="_blank" rel="noopener" style="${isSearch ? 'background:#1c1c1c;color:#777;border:1px solid #2a2a2a;' : ''}">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="${isSearch ? '#777' : 'white'}"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
            ${isSearch ? 'Search YouTube &rarr;' : 'Watch on YouTube'}
           </a>`;
      })()}
    </div>`;
  }
  return `<div class="ex-card${isExpanded?' expanded':''}${editModeActive?' edit-mode-card':''}" id="card-${ex.id}" onclick="toggleCard(${ex.id})">
    <div class="ex-card-main">
      <div class="muscle-bar" style="background:${color}"></div>
      <div class="ex-info">
        <div class="ex-name">${ex.n||'Unnamed'}</div>
        <div class="ex-sub">
          <span class="tag tag-muscle">${ex.m||'â€”'}</span>
          <span class="tag tag-diff ${diffClass}">${ex.d||'â€”'}</span>
          ${ex.e&&ex.e!=='BW'?`<span class="tag tag-equip">${ex.e}</span>`:''}
        </div>
      </div>
      <div class="ex-right">
        ${ex.v&&!isExpanded?`<svg class="yt-icon" width="18" height="13" viewBox="0 0 20 14" fill="#ff4444"><path d="M19.582 2.186A2.506 2.506 0 0 0 17.82.418C16.254 0 10 0 10 0S3.746 0 2.18.418A2.506 2.506 0 0 0 .418 2.186C0 3.754 0 7 0 7s0 3.246.418 4.814a2.506 2.506 0 0 0 1.762 1.768C3.746 14 10 14 10 14s6.254 0 7.82-.418a2.506 2.506 0 0 0 1.762-1.768C20 10.246 20 7 20 7s0-3.246-.418-4.814zM8 10V4l5.333 3L8 10z"/></svg>`:''}
        ${!editModeActive?`<button class="map-btn" onclick="event.stopPropagation();openExplorer(${ex.id})" title="Open in Visual Map">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><circle cx="4" cy="6" r="2"/><circle cx="20" cy="6" r="2"/><circle cx="4" cy="18" r="2"/><circle cx="20" cy="18" r="2"/><line x1="6" y1="6" x2="10" y2="10"/><line x1="18" y1="6" x2="14" y2="10"/><line x1="6" y1="18" x2="10" y2="14"/><line x1="18" y1="18" x2="14" y2="14"/></svg>
        </button>`:''}
        ${!editModeActive?`<button class="add-session-btn${sessionList.some(s=>s.id===ex.id)?' in-session':''}" data-id="${ex.id}" onclick="toggleSession(${ex.id}, event)" title="${sessionList.some(s=>s.id===ex.id)?'Remove from session':'Add to session'}">
          ${sessionList.some(s=>s.id===ex.id)
            ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`
            : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`}
        </button>`:''}
        ${!editModeActive?`<button class="heart-btn${isFav?' favorited':''}" onclick="toggleFavorite(${ex.id}, event)" title="${isFav?'Remove from favorites':'Add to favorites'}">${heartSVG()}</button>`:''}
        ${editModeActive?`<div style="color:var(--muted);font-size:11px;font-family:'Space Mono',monospace;padding:2px 4px;">âœŽ</div>`:''}
      </div>
    </div>
    ${detailHtml}
  </div>`;
}

function toggleCard(id) {
  if (editModeActive) {
    // In edit mode: expand to show inline edit form
    expandedId = expandedId === id ? null : id;
    render();
    if (expandedId !== null) {
      setTimeout(()=>{ const el=document.getElementById('card-'+id); if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'}); }, 50);
    }
    return;
  }
  expandedId = expandedId === id ? null : id;
  render();
  if (expandedId !== null) {
    setTimeout(()=>{ const el=document.getElementById('card-'+id); if(el) el.scrollIntoView({behavior:'smooth',block:'nearest'}); }, 50);
  }
}
function loadMore() { displayCount += 40; render(); }

// EDIT PANEL
let editTab = 'add';
let editModeActive = false;

function enterEditMode() {
  editModeActive = true;
  document.getElementById('editModeBar').classList.add('show');
}
function exitEditMode() {
  editModeActive = false;
  document.getElementById('editModeBar').classList.remove('show');
  closeEdit();
}
function openEdit() { 
  enterEditMode();
  document.getElementById('editPanel').classList.add('open'); 
  switchEditTab('add', document.querySelector('.mode-tab')); 
}
function closeEdit() { document.getElementById('editPanel').classList.remove('open'); }
function switchEditTab(tab, el) {
  editTab = tab;
  document.querySelectorAll('.mode-tab').forEach(t=>t.classList.remove('active')); el.classList.add('active');
  renderEditTab();
}
function exerciseForm(ex={}) {
  return `
    <div class="form-group"><label>Exercise Name *</label><input id="f_name" placeholder="e.g. Romanian Deadlift (DB)" value="${ex.n||''}"></div>
    <div class="form-row">
      <div class="form-group"><label>Primary Muscle *</label><select id="f_muscle">${MUSCLES_LIST.map(m=>`<option${ex.m===m?' selected':''}>${m}</option>`).join('')}</select></div>
      <div class="form-group"><label>Difficulty</label><select id="f_diff">${DIFFS_LIST.map(d=>`<option${ex.d===d?' selected':''}>${d}</option>`).join('')}</select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Equipment</label><input id="f_equip" placeholder="e.g. KB, DB, BW" value="${ex.e||''}"></div>
      <div class="form-group"><label>Secondary Muscle</label><input id="f_sec" placeholder="optional" value="${ex.s||''}"></div>
    </div>
    <div class="form-group"><label>Movement Pattern</label><input id="f_mv" placeholder="e.g. Hip Extension" value="${ex.mv||''}"></div>
    <div class="form-group"><label>YouTube URL</label><input id="f_video" placeholder="https://youtu.be/..." value="${ex.v||''}"></div>`;
}
function renderEditTab() {
  const el = document.getElementById('editTabContent');
  if (editTab==='add') {
    el.innerHTML = exerciseForm() + `<button class="btn-primary" onclick="addExercise()">Add Exercise</button>`;
  } else if (editTab==='edit') {
    el.innerHTML = `<div class="form-group"><label>Search Exercise to Edit</label><input id="editSearch" placeholder="Type name..." oninput="searchEditItems(this.value,'edit')"></div><div class="edit-search-results" id="editResults"></div><div id="editForm"></div>`;
  } else {
    el.innerHTML = `<div class="form-group"><label>Search Exercise to Delete</label><input id="deleteSearch" placeholder="Type name..." oninput="searchEditItems(this.value,'delete')"></div><div class="edit-search-results" id="editResults"></div>`;
  }
}
function searchEditItems(q, mode) {
  const q2 = q.toLowerCase();
  const matches = exercises.filter(e=>(e.n||'').toLowerCase().includes(q2)).slice(0,20);
  document.getElementById('editResults').innerHTML = matches.map(ex=>`
    <div class="edit-result-item" onclick="selectEditItem(${ex.id},'${mode}')">
      <div class="eri-name">${ex.n}</div>
      <div class="eri-sub">${ex.m||''} Â· ${ex.d||''}</div>
    </div>`).join('') || '<div style="color:var(--muted);font-size:12px;padding:8px;font-family:Space Mono">No results</div>';
}
function selectEditItem(id, mode) {
  const ex = exercises.find(e=>e.id===id);
  if (!ex) return;
  if (mode==='edit') {
    document.getElementById('editResults').innerHTML='';
    document.getElementById('editForm').innerHTML = exerciseForm(ex) + `<button class="btn-primary" onclick="saveEdit(${id})">Save Changes</button>`;
  } else {
    document.getElementById('editResults').innerHTML = `
      <div class="edit-result-item" style="border-color:#f87171"><div class="eri-name">${ex.n}</div><div class="eri-sub">${ex.m} Â· ${ex.d}</div></div>
      <button class="btn-danger" onclick="deleteExercise(${id})">Delete "${ex.n}"</button>`;
  }
}
function getFormData() {
  return {
    n: document.getElementById('f_name').value.trim(),
    m: document.getElementById('f_muscle').value,
    d: document.getElementById('f_diff').value,
    e: document.getElementById('f_equip').value.trim(),
    s: document.getElementById('f_sec').value.trim() || null,
    mv: document.getElementById('f_mv').value.trim() || null,
    v: document.getElementById('f_video').value.trim() || null,
    c: null,
  };
}
async function addExercise() {
  const fd = getFormData();
  if (!fd.n) { alert('Exercise name is required'); return; }
  const res = await sbFetch('exercises', { method:'POST', body: JSON.stringify(fd), prefer:'return=representation', returnData:true });
  const newEx = Array.isArray(res) ? res[0] : res;
  exercises.unshift(newEx);
  render(); showToast('Exercise added!');
  // Stay in edit mode â€” reset the form for another addition
  renderEditTab();
}
async function saveEdit(id) {
  const fd = getFormData();
  if (!fd.n) { alert('Exercise name is required'); return; }
  await sbFetch(`exercises?id=eq.${id}`, { method:'PATCH', body: JSON.stringify(fd) });
  const idx = exercises.findIndex(e=>e.id===id);
  if (idx>-1) exercises[idx] = {...exercises[idx], ...fd};
  render(); showToast('Changes saved!');
  // Stay in edit mode
  renderEditTab();
}
async function deleteExercise(id) {
  if (!confirm('Delete this exercise?')) return;
  await sbFetch(`exercises?id=eq.${id}`, { method:'DELETE' });
  exercises = exercises.filter(e=>e.id!==id);
  render(); showToast('Deleted.');
  // Stay in edit mode
  renderEditTab();
}
function showToast(msg, isHeart=false, onClick=null) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast' + (isHeart ? ' heart-toast' : '') + (onClick ? ' roulette-toast' : '');
  if (sessionList.length > 0) t.classList.add('tray-up');
  t.onclick = onClick || null;
  t.classList.add('show');
  if (t._toastTimer) clearTimeout(t._toastTimer);
  t._toastTimer = setTimeout(() => { t.classList.remove('show'); t.onclick = null; }, 3500);
}

// EXERCISE ROULETTE
// â”€â”€ WHEEL OF GAINS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let wheelPool = [];        // Core exercises only
let wheelPickedEx = null;  // The exercise that was landed on
let wheelSpinning = false;
let wheelAnimFrame = null;

function openWheel() {
  // Pool: Core exercises only, capped at Advanced difficulty
  const allowedDiffs = ['Novice', 'Beginner', 'Intermediate', 'Advanced'];
  wheelPool = exercises.filter(e => e.m === 'Core' && allowedDiffs.includes(e.d));
  if (wheelPool.length === 0) { showToast('No Core exercises found!'); return; }

  wheelPickedEx = null;
  wheelSpinning = false;

  // Reset UI
  document.getElementById('wheelResult').classList.remove('show');
  document.getElementById('wheelSpinBtn').style.display = '';
  document.getElementById('wheelSpinBtn').disabled = false;
  document.getElementById('wheelPoolLabel').innerHTML =
    `Drawing from <strong>${wheelPool.length}</strong> Core exercises`;

  // Build initial drum with random slots (preview state)
  buildDrum(null);

  document.getElementById('wheelOverlay').classList.add('open');
}

function closeWheel() {
  document.getElementById('wheelOverlay').classList.remove('open');
  if (wheelAnimFrame) { cancelAnimationFrame(wheelAnimFrame); wheelAnimFrame = null; }
}

function buildDrum(pickedId) {
  // We show a shuffled list of slots â€” enough rows to scroll through
  const inner = document.getElementById('wheelDrumInner');
  const drum  = document.getElementById('wheelDrum');

  // Make a long list: shuffle pool, repeat to fill ~30 rows
  const rows = [];
  const shuffled = [...wheelPool].sort(() => Math.random() - 0.5);
  while (rows.length < 30) rows.push(...shuffled);

  // Inject the picked exercise near the end so it lands in the selector
  if (pickedId !== null) {
    const pickedIdx = rows.findIndex(e => e.id === pickedId);
    if (pickedIdx !== -1) rows.splice(pickedIdx, 1);
    rows.splice(rows.length - 3, 0, wheelPool.find(e => e.id === pickedId));
  }

  inner.innerHTML = rows.map((ex, i) => {
    const isLanded = pickedId !== null && i === rows.length - 3;
    return `<div class="wheel-slot${isLanded ? ' landed' : ''}">
      <div class="wheel-slot-name">${ex.n || 'Unnamed'}</div>
      <div class="wheel-slot-diff">${(ex.d || '').toUpperCase()}</div>
    </div>`;
  }).join('');

  // Reset scroll to top
  drum.scrollTop = 0;
  inner.style.transform = 'translateY(0px)';

  return { rows, slotHeight: 72 };
}

function spinWheel() {
  if (wheelSpinning || wheelPool.length === 0) return;
  wheelSpinning = true;

  // Hide result, disable spin button
  document.getElementById('wheelResult').classList.remove('show');
  document.getElementById('wheelSpinBtn').disabled = true;

  // Pick the winner upfront
  wheelPickedEx = wheelPool[Math.floor(Math.random() * wheelPool.length)];

  // Build drum with winner placed near end
  const { rows, slotHeight } = buildDrum(wheelPickedEx.id);

  const inner = document.getElementById('wheelDrumInner');
  const drum  = document.getElementById('wheelDrum');

  // The center of the drum window = slot 2 (0-indexed) at start
  // We want the landed slot (rows.length - 3) to end up centered
  // Drum height = 360, slot height = 72, center offset = 144px (2 slots)
  const drumVisibleCenter = 144; // px from top of drum to center line
  const targetSlotIndex = rows.length - 3;
  const targetY = targetSlotIndex * slotHeight - drumVisibleCenter;

  // Animation: ease-in then ease-out (custom cubic)
  const totalDuration = 2000; // ms â€” 2 seconds total
  const startTime = performance.now();

  function easeInOutCubic(t) {
    return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
  }
  // Extra "overshoot" kick at the very start
  function easingFn(t) {
    // Fast start, dramatic slow-down at end
    if (t < 0.15) return t * 3.5; // fast launch
    return 0.525 + easeInOutCubic((t - 0.15) / 0.85) * 0.475;
  }

  function frame(now) {
    const elapsed = now - startTime;
    const t = Math.min(elapsed / totalDuration, 1);
    const progress = easingFn(t);
    const currentY = progress * targetY;

    inner.style.transform = `translateY(-${currentY}px)`;

    if (t < 1) {
      wheelAnimFrame = requestAnimationFrame(frame);
    } else {
      // Landed
      wheelSpinning = false;
      wheelAnimFrame = null;
      onWheelLanded();
    }
  }

  wheelAnimFrame = requestAnimationFrame(frame);
}

function onWheelLanded() {
  // Show result panel
  document.getElementById('wheelResult').classList.add('show');
  document.getElementById('wheelSpinBtn').style.display = 'none';

  // Flash the landed slot
  const slots = document.querySelectorAll('.wheel-slot');
  const landedSlot = slots[slots.length - 3];
  if (landedSlot) {
    landedSlot.classList.add('landed');
  }
}

function wheelGo() {
  if (!wheelPickedEx) return;
  closeWheel();

  // Clear all filters so the exercise is guaranteed to be visible
  currentRegion = 'all';
  currentMuscle = 'all';
  currentDiff = 'all';
  currentSearch = '';
  showFavoritesOnly = false;
  document.getElementById('searchInput').value = '';
  document.querySelectorAll('#regionRow .pill').forEach((p,i) => p.classList.toggle('active', i===0));
  document.querySelectorAll('#diffRow .pill').forEach((p,i) => p.classList.toggle('active', i===0));
  document.getElementById('favPill').classList.remove('active');
  buildMusclePills('all');
  updateFilterToggleState();

  // Make sure displayCount is large enough to show this exercise
  const idx = exercises.findIndex(e => e.id === wheelPickedEx.id);
  if (idx >= 0) displayCount = Math.max(displayCount, idx + 1);

  // Expand the card
  expandedId = wheelPickedEx.id;
  render();

  // Scroll to card and apply glow highlight
  setTimeout(() => {
    const card = document.getElementById('card-' + wheelPickedEx.id);
    if (card) {
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      card.classList.add('wheel-highlight');
      card.addEventListener('animationend', () => card.classList.remove('wheel-highlight'), { once: true });
    }
  }, 80);
}

function wheelSpinAgain() {
  // Reset to spin state without closing
  document.getElementById('wheelResult').classList.remove('show');
  document.getElementById('wheelSpinBtn').style.display = '';
  document.getElementById('wheelSpinBtn').disabled = false;
  buildDrum(null);
  wheelPickedEx = null;
}

// Wire up the ðŸŽ² button to open the wheel instead of old roulette
function exerciseRoulette() {
  if (!exercises || exercises.length === 0) { showToast('No exercises loaded yet!'); return; }
  openWheel();
}

// â”€â”€ Session Tray â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSession(exerciseId, event) {
  event.stopPropagation();
  const ex = exercises.find(e => e.id === exerciseId);
  if (!ex) return;

  const btn = event.currentTarget;
  const idx = sessionList.findIndex(s => s.id === exerciseId);
  const isInSession = idx > -1;

  if (isInSession) {
    sessionList.splice(idx, 1);
    btn.classList.remove('in-session');
  } else {
    sessionList.push({ id: ex.id, name: ex.n || 'Unnamed', video: ex.v || null });
    btn.classList.add('in-session');
    btn.classList.add('pop');
    btn.addEventListener('animationend', () => btn.classList.remove('pop'), { once: true });
  }

  updateSessionTray();
}

function updateSessionTray() {
  const tray = document.getElementById('sessionTray');
  const list = document.getElementById('trayList');
  const count = document.getElementById('trayCount');

  count.textContent = sessionList.length;
  tray.classList.toggle('visible', sessionList.length > 0);

  list.innerHTML = sessionList.map((s, i) => `
    <div class="tray-item" id="tray-item-${s.id}" onclick="goToExerciseFromTray(${s.id})">
      <span class="tray-item-num">${String(i + 1).padStart(2, '0')}</span>
      <span class="tray-item-name">${s.name}</span>
      <button class="tray-item-remove" onclick="event.stopPropagation();removeFromSession(${s.id})" title="Remove">Ã—</button>
    </div>
  `).join('');
}

function goToExerciseFromTray(exerciseId) {
  // Clear filters so exercise is guaranteed visible
  currentRegion = 'all';
  currentMuscle = 'all';
  currentDiff = 'all';
  currentSearch = '';
  showFavoritesOnly = false;
  document.getElementById('searchInput').value = '';
  document.querySelectorAll('#regionRow .pill').forEach((p,i) => p.classList.toggle('active', i===0));
  document.querySelectorAll('#diffRow .pill').forEach((p,i) => p.classList.toggle('active', i===0));
  document.getElementById('favPill').classList.remove('active');
  buildMusclePills('all');
  updateFilterToggleState();

  const idx = exercises.findIndex(e => e.id === exerciseId);
  if (idx >= 0) displayCount = Math.max(displayCount, idx + 1);

  expandedId = exerciseId;
  render();

  setTimeout(() => {
    const card = document.getElementById('card-' + exerciseId);
    if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 80);
}

function removeFromSession(exerciseId) {
  sessionList = sessionList.filter(s => s.id !== exerciseId);
  // Update the + button on the card if visible
  const btn = document.querySelector(`.add-session-btn[data-id="${exerciseId}"]`);
  if (btn) btn.classList.remove('in-session');
  updateSessionTray();
}

function clearSession() {
  sessionList = [];
  // Reset all + buttons
  document.querySelectorAll('.add-session-btn.in-session').forEach(b => b.classList.remove('in-session'));
  updateSessionTray();
}

function shareSession() {
  if (sessionList.length === 0) return;
  const lines = sessionList.map((s, i) => {
    const num = `${i + 1})`;
    return s.video ? `${num} ${s.name} - ${s.video}` : `${num} ${s.name}`;
  });
  const text = `Today's Workout:\n${lines.join('\n')}`;
  navigator.clipboard.writeText(text)
    .then(() => showToast('Workout copied to clipboard! ðŸ’ª'))
    .catch(() => {
      // Fallback for older browsers
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed'; ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showToast('Workout copied to clipboard! ðŸ’ª');
    });
}

// â”€â”€ VISUAL EXPLORER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let explorerActiveId = null;
let explorerHistory = []; // stack for back-navigation within explorer
let explorerFocusedId = null; // satellite that got first click (focus state)
let explorerClickTimer = null; // timer to detect double-click on satellite

// Heuristic neighbor-finding based on name tokens and difficulty
// Regressions: same muscle, lower diff | Progressions: same muscle, higher diff | Variations: same name root
function getExplorerNeighbors(ex) {
  const diffIdx = DIFF_ORDER.indexOf(ex.d);
  const sameMuscle = exercises.filter(e => e.id !== ex.id && e.m === ex.m);

  // Name similarity: extract root words (â‰¥4 chars, ignore parens content)
  function nameTokens(name) {
    return (name || '').toLowerCase()
      .replace(/\(.*?\)/g, '')
      .split(/\s+/)
      .filter(t => t.length >= 4);
  }
  const myTokens = nameTokens(ex.n);

  // Variations: different diff, shares â‰¥1 significant name token
  const variations = exercises.filter(e => {
    if (e.id === ex.id) return false;
    const shared = nameTokens(e.n).some(t => myTokens.includes(t));
    return shared;
  }).slice(0, 3);

  const varIds = new Set(variations.map(e => e.id));

  // Regressions: same muscle, lower diff, not a variation
  const regressions = sameMuscle
    .filter(e => DIFF_ORDER.indexOf(e.d) < diffIdx && !varIds.has(e.id))
    .sort((a, b) => DIFF_ORDER.indexOf(b.d) - DIFF_ORDER.indexOf(a.d)) // closest diff first
    .slice(0, 2);

  // Progressions: same muscle, higher diff, not a variation
  const progressions = sameMuscle
    .filter(e => DIFF_ORDER.indexOf(e.d) > diffIdx && !varIds.has(e.id))
    .sort((a, b) => DIFF_ORDER.indexOf(a.d) - DIFF_ORDER.indexOf(b.d)) // closest diff first
    .slice(0, 2);

  return { regressions, progressions, variations };
}

function openExplorer(startId = null) {
  const overlay = document.getElementById('explorerOverlay');
  document.getElementById('explorerBtn').classList.add('active');
  overlay.classList.add('open');

  // Pick a starting exercise
  if (startId) {
    explorerActiveId = startId;
  } else if (expandedId) {
    explorerActiveId = expandedId;
  } else if (exercises.length > 0) {
    explorerActiveId = exercises[Math.floor(Math.random() * exercises.length)].id;
  }
  explorerHistory = [];
  explorerFocusedId = null;
  renderExplorer();
  setupExplorerSearch();
}

function closeExplorer() {
  document.getElementById('explorerOverlay').classList.remove('open');
  document.getElementById('explorerBtn').classList.remove('active');
  explorerFocusedId = null;
}

// Center node: one click opens exercise detail (closes explorer, expands card)
function explorerOpenCenter(id) {
  closeExplorer();
  expandedId = id;
  // Reset display count so card is visible
  const filtered = getFiltered();
  const idx = exercises.findIndex(e => e.id === id);
  if (idx >= 0) displayCount = Math.max(displayCount, idx + 1);
  render();
  setTimeout(() => {
    const el = document.getElementById('card-' + id);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 60);
}

// Satellite node: one click moves it to center
function satelliteClick(id) {
  if (explorerActiveId !== null) explorerHistory.push(explorerActiveId);
  explorerActiveId = id;
  explorerFocusedId = null;
  renderExplorer();
}

function navigateExplorer(id) {
  if (explorerActiveId !== null) explorerHistory.push(explorerActiveId);
  explorerActiveId = id;
  explorerFocusedId = null;
  renderExplorer();
}

function renderExplorer() {
  if (!explorerActiveId || exercises.length === 0) return;
  const ex = exercises.find(e => e.id === explorerActiveId);
  if (!ex) return;

  const { regressions, progressions, variations } = getExplorerNeighbors(ex);
  const canvas = document.getElementById('explorerCanvas');
  const nodesEl = document.getElementById('explorerNodes');
  const linesEl = document.getElementById('explorerLines');

  const W = canvas.offsetWidth;
  const H = canvas.offsetHeight;
  const cx = W / 2;
  const cy = H / 2;

  const isMobile = W < 500;

  // Node pixel dimensions (must match CSS exactly)
  const CENTER_H = isMobile ? 150 : 170; // approximate center node height
  const SAT_H    = isMobile ? 76  : 84;  // satellite node height (fixed in CSS)
  const SAT_W    = isMobile ? 96  : 110;

  // Gap = half center height + padding + half sat height
  const vGap = Math.floor(CENTER_H / 2) + 28 + Math.floor(SAT_H / 2);
  // Horizontal gap for variations (edge-to-edge clearance from center)
  const hGap = Math.floor(SAT_W / 2) + (isMobile ? 80 : 100);
  // Horizontal spread when 2 regressions/progressions side by side
  const hSpread = SAT_W + (isMobile ? 12 : 16);

  const positions = [];

  // REGRESSIONS â€” above center
  regressions.forEach((e, i) => {
    const offset = (i - (regressions.length - 1) / 2) * hSpread;
    positions.push({ ex: e, x: cx + offset, y: cy - vGap, type: 'regression' });
  });

  // PROGRESSIONS â€” below center
  progressions.forEach((e, i) => {
    const offset = (i - (progressions.length - 1) / 2) * hSpread;
    positions.push({ ex: e, x: cx + offset, y: cy + vGap, type: 'progression' });
  });

  // VARIATIONS â€” left and right of center
  variations.forEach((e, i) => {
    const side = i % 2 === 0 ? -1 : 1;
    const extraX = i >= 2 ? side * hGap : 0;
    const x = cx + side * hGap + extraX;
    positions.push({ ex: e, x, y: cy, type: 'variation' });
  });

  const muscleColor = MUSCLE_COLORS[ex.m] || '#888';
  const diffClass = (ex.d || '').toLowerCase().replace(' ', '');
  const isFav = favoriteIds.has(ex.id);
  const inSession = sessionList.some(s => s.id === ex.id);

  // SVG lines from center to each satellite
  linesEl.innerHTML = positions.map(({ x, y, type }, i) => {
    const delay = (i * 0.05).toFixed(2);
    return `<line class="explorer-line ${type}" x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" style="animation-delay:${delay}s"/>`;
  }).join('');

  let html = '';

  // CENTER NODE â€” click opens detail card
  html += `<div class="explorer-node center-node" style="left:${cx}px;top:${cy}px" onclick="explorerOpenCenter(${ex.id})">
    <div class="cn-accent-bar" style="background:${muscleColor}"></div>
    <div class="cn-name">${ex.n || 'Unnamed'}</div>

    <div class="cn-actions">
      <button class="cn-btn add-btn${inSession ? ' in-session' : ''}" onclick="event.stopPropagation();explorerToggleSession(${ex.id},event)">
        ${inSession ? 'âœ“ Added' : '+ Session'}
      </button>
      <button class="cn-btn fav-btn${isFav ? ' favorited' : ''}" onclick="event.stopPropagation();explorerToggleFav(${ex.id},event)">
        ${isFav ? 'â™¥' : 'â™¡'}
      </button>
    </div>
  </div>`;

  // SATELLITE NODES â€” click moves to center
  positions.forEach(({ ex: sat, x, y, type }, i) => {
    const satDiffClass = (sat.d || '').toLowerCase().replace(' ', '');
    html += `<div class="explorer-node satellite-node type-${type}"
      style="left:${x}px;top:${y}px;animation-delay:${(i * 0.05 + 0.1).toFixed(2)}s"
      onclick="satelliteClick(${sat.id})">
      <div class="sat-inner">
        <div class="sat-type-label">${type}</div>
        <div class="sat-name">${sat.n || 'Unnamed'}</div>
      </div>
    </div>`;
  });

  // EMPTY PLACEHOLDERS â€” one per group if empty
  if (regressions.length === 0)
    html += `<div class="explorer-node satellite-node sat-empty type-regression" style="left:${cx}px;top:${cy - vGap}px"><div class="sat-inner"><div class="sat-type-label">regression</div><div class="sat-name">None found</div></div></div>`;
  if (progressions.length === 0)
    html += `<div class="explorer-node satellite-node sat-empty type-progression" style="left:${cx}px;top:${cy + vGap}px"><div class="sat-inner"><div class="sat-type-label">progression</div><div class="sat-name">None found</div></div></div>`;
  if (variations.length === 0)
    html += `<div class="explorer-node satellite-node sat-empty type-variation" style="left:${cx - hGap}px;top:${cy}px"><div class="sat-inner"><div class="sat-type-label">variation</div><div class="sat-name">None found</div></div></div>`;

  nodesEl.innerHTML = html;
}

function explorerToggleSession(id, event) {
  event.stopPropagation();
  const ex = exercises.find(e => e.id === id);
  if (!ex) return;
  const idx = sessionList.findIndex(s => s.id === id);
  if (idx > -1) {
    sessionList.splice(idx, 1);
  } else {
    sessionList.push({ id: ex.id, name: ex.n || 'Unnamed', video: ex.v || null });
    showToast('+ Added to session', false);
  }
  updateSessionTray();
  renderExplorer(); // refresh center node button state
}

function explorerToggleFav(id, event) {
  event.stopPropagation();
  const isFav = favoriteIds.has(id);
  if (isFav) {
    favoriteIds.delete(id);
    showToast('Removed from favorites');
  } else {
    favoriteIds.add(id);
    showToast('â™¥ Added to favorites', true);
  }
  // Optimistic sync
  if (isFav) {
    sbFetch(`favorites?user_id=eq.${encodeURIComponent(USER_ID)}&exercise_id=eq.${id}`, { method: 'DELETE' });
  } else {
    sbFetch('favorites', { method: 'POST', body: JSON.stringify({ user_id: USER_ID, exercise_id: id }), prefer: 'return=minimal' });
  }
  renderExplorer();
}

function setupExplorerSearch() {
  const input = document.getElementById('explorerSearch');
  const dropdown = document.getElementById('explorerDropdown');

  input.value = '';
  dropdown.style.display = 'none';

  input.oninput = () => {
    const q = input.value.trim().toLowerCase();
    if (!q) { dropdown.style.display = 'none'; return; }
    const matches = exercises.filter(e => (e.n || '').toLowerCase().includes(q)).slice(0, 8);
    if (!matches.length) { dropdown.style.display = 'none'; return; }
    dropdown.innerHTML = matches.map(e => `
      <div class="explorer-dropdown-item" onclick="explorerJump(${e.id})">
        <div class="edi-name">${e.n}</div>
        <div class="edi-sub">${e.m || ''} Â· ${e.d || ''}</div>
      </div>`).join('');
    dropdown.style.display = 'block';
  };

  document.addEventListener('click', (ev) => {
    if (!input.contains(ev.target) && !dropdown.contains(ev.target)) {
      dropdown.style.display = 'none';
    }
  }, { capture: true });
}

function explorerJump(id) {
  document.getElementById('explorerSearch').value = '';
  document.getElementById('explorerDropdown').style.display = 'none';
  explorerFocusedId = null;
  navigateExplorer(id);
}

// Re-render explorer on resize so positions stay correct
window.addEventListener('resize', () => {
  if (document.getElementById('explorerOverlay').classList.contains('open')) {
    renderExplorer();
  }
});

// INLINE EDIT (edit mode on card)
async function inlineSaveEdit(id) {
  const fd = {
    n: document.getElementById(`ie_name_${id}`).value.trim(),
    m: document.getElementById(`ie_muscle_${id}`).value,
    d: document.getElementById(`ie_diff_${id}`).value,
    e: document.getElementById(`ie_equip_${id}`).value.trim(),
    s: document.getElementById(`ie_sec_${id}`).value.trim() || null,
    mv: document.getElementById(`ie_mv_${id}`).value.trim() || null,
    v: document.getElementById(`ie_video_${id}`).value.trim() || null,
  };
  if (!fd.n) { showToast('Name is required'); return; }
  await sbFetch(`exercises?id=eq.${id}`, { method:'PATCH', body: JSON.stringify(fd) });
  const idx = exercises.findIndex(e=>e.id===id);
  if (idx>-1) exercises[idx] = {...exercises[idx], ...fd};
  expandedId = null;
  render();
  showToast('âœ“ Saved');
}
async function inlineDeleteExercise(id) {
  const ex = exercises.find(e=>e.id===id);
  if (!confirm(`Delete "${ex?.n||'this exercise'}"?`)) return;
  await sbFetch(`exercises?id=eq.${id}`, { method:'DELETE' });
  exercises = exercises.filter(e=>e.id!==id);
  expandedId = null;
  render();
  showToast('Deleted.');
}

// BACK TO TOP
const backToTopBtn = document.getElementById('backToTop');
window.addEventListener('scroll', () => {
  const scrolled = window.scrollY > 300;
  backToTopBtn.classList.toggle('visible', scrolled);
  backToTopBtn.classList.toggle('tray-up', scrolled && sessionList.length > 0);
}, { passive: true });

loadExercises();
</script>
</body>
</html>
