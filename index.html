<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Wilde">
<meta name="theme-color" content="#0a0a0a">
<title>Wilde</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0a;
  --surface: #141414;
  --surface2: #1e1e1e;
  --border: #242424;
  --border2: #2e2e2e;
  --text: #f0f0f0;
  --muted: #666;
  --muted2: #999;
  --accent: #e8ff47;
  --heart: #ff4d6d;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; min-height: 100vh; }
body { overflow-x: hidden; }

/* BACK TO TOP */
#backToTop {
  position: fixed;
  bottom: 24px;
  right: 16px;
  z-index: 350;
  width: 36px; height: 36px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s, transform 0.2s, bottom 0.35s cubic-bezier(0.4,0,0.2,1);
  color: var(--muted2);
}
#backToTop.visible { opacity: 1; pointer-events: auto; }
#backToTop.tray-up { bottom: 170px; }
#backToTop:hover { color: var(--accent); border-color: var(--accent); transform: translateY(-2px); }
#backToTop:active { transform: scale(0.92); }
#backToTop svg { width: 16px; height: 16px; }

/* INSTALL BANNER */
#installBanner { display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999; background: var(--accent); color: #0a0a0a; padding: 16px 20px; gap: 12px; align-items: center; font-family: 'Space Mono', monospace; font-size: 13px; border-top: 2px solid #0a0a0a; }
#installBanner.show { display: flex; }
#installBanner .bt { flex: 1; line-height: 1.5; }
#installBanner .bt strong { display: block; font-size: 14px; margin-bottom: 2px; }
#installBanner button { background: #0a0a0a; color: var(--accent); border: none; padding: 8px 14px; border-radius: 6px; font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; }

/* HEADER */
header { position: sticky; top: 0; z-index: 100; background: var(--bg); border-bottom: 1px solid var(--border); padding: 0 12px; }
.header-top { display: flex; align-items: center; height: 52px; gap: 8px; }
.logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 20px; letter-spacing: -0.03em; color: var(--text); flex-shrink: 0; cursor: pointer; user-select: none; }
.logo span { color: var(--accent); }

.search-wrap { flex: 1; min-width: 0; position: relative; }
.search-wrap svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); width: 16px; height: 16px; pointer-events: none; }
#searchInput { width: 100%; background: var(--surface); border: 1px solid var(--border2); border-radius: 8px; padding: 8px 12px 8px 34px; color: var(--text); font-family: 'Syne', sans-serif; font-size: 14px; outline: none; transition: border-color 0.15s; }
#searchInput:focus { border-color: var(--accent); }
#searchInput::placeholder { color: var(--muted); }

/* FILTER TOGGLE PILL */
.filter-toggle-btn { padding: 7px 12px; border-radius: 999px; font-size: 12px; font-weight: 700; cursor: pointer; border: 1.5px solid var(--border2); background: var(--surface); color: var(--muted2); font-family: 'Syne', sans-serif; white-space: nowrap; flex-shrink: 0; transition: all 0.15s; display: flex; align-items: center; gap: 5px; }
.filter-toggle-btn:hover { color: var(--text); border-color: var(--border2); }
.filter-toggle-btn.active { background: var(--surface2); color: var(--text); border-color: var(--accent); }
.filter-toggle-btn .filter-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); display: none; flex-shrink: 0; }
.filter-toggle-btn.has-filters .filter-dot { display: block; }

/* FILTER DRAWER */
#filterDrawer { 
  background: var(--bg); 
  overflow: hidden; 
  max-height: 0; 
  transition: max-height 0.3s cubic-bezier(0.4,0,0.2,1), border-bottom-width 0.3s; 
  border-bottom: 0px solid var(--border);
  position: sticky;
  top: 53px;
  z-index: 99;
}
#filterDrawer.open { max-height: 600px; border-bottom: 1px solid var(--border); }

/* FILTER */
.filter-section { background: var(--bg); }
.filter-label { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; padding: 8px 20px 0; }
.filter-row { display: flex; gap: 6px; padding: 8px 16px 10px; flex-wrap: wrap; }
#muscleRow { max-height: 96px; overflow-y: auto; scrollbar-width: none; }
#muscleRow::-webkit-scrollbar { display: none; }
.pill { padding: 5px 14px; border-radius: 999px; font-size: 12px; font-weight: 700; cursor: pointer; border: 1.5px solid var(--border); white-space: nowrap; transition: all 0.15s; background: var(--surface); color: var(--muted2); flex-shrink: 0; }
.pill:hover { color: var(--text); border-color: var(--border2); }
.pill.active { background: var(--accent); color: #0a0a0a; border-color: var(--accent); }
.pill.region-upper.active { background: #60a5fa; border-color: #60a5fa; color: #000; }
.pill.region-core.active { background: #34d399; border-color: #34d399; color: #000; }
.pill.region-lower.active { background: #f472b6; border-color: #f472b6; color: #000; }
.pill.diff-novice.active      { background: #38bdf8; border-color: #38bdf8; color: #000; }
.pill.diff-beginner.active    { background: #4ade80; border-color: #4ade80; color: #000; }
.pill.diff-intermediate.active{ background: #facc15; border-color: #facc15; color: #000; }
.pill.diff-advanced.active    { background: #fb923c; border-color: #fb923c; color: #000; }
.pill.diff-expert.active      { background: #f87171; border-color: #f87171; color: #000; }
.pill.diff-master.active      { background: #c084fc; border-color: #c084fc; color: #000; }

/* EDIT MODE INDICATOR */
#editModeBar { 
  display: none; 
  position: fixed; 
  top: 0; left: 0; right: 0; 
  z-index: 9998; 
  background: var(--accent); 
  color: #0a0a0a; 
  padding: 6px 16px; 
  font-family: 'Space Mono', monospace; 
  font-size: 11px; 
  font-weight: 700; 
  align-items: center; 
  justify-content: space-between;
  gap: 12px;
}
#editModeBar.show { display: flex; }
#editModeBar .em-label { display: flex; align-items: center; gap: 6px; }
#editModeBar .em-dot { width: 6px; height: 6px; border-radius: 50%; background: #0a0a0a; animation: emPulse 1.2s ease-in-out infinite; }
@keyframes emPulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
#editModeBar .em-exit { background: #0a0a0a; color: var(--accent); border: none; padding: 4px 12px; border-radius: 5px; font-family: 'Space Mono', monospace; font-size: 10px; font-weight: 700; cursor: pointer; white-space: nowrap; }
#editModeBar .em-exit:hover { opacity: 0.8; }

/* FAVORITES PILL */
.pill.fav-pill { display: flex; align-items: center; gap: 5px; }
.pill.fav-pill svg { width: 11px; height: 11px; flex-shrink: 0; }
.pill.fav-pill.active { background: var(--heart); border-color: var(--heart); color: #fff; }
.pill.fav-pill.active svg { fill: #fff; stroke: #fff; }

/* RESULTS BAR */
.results-bar { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-bottom: 1px solid var(--border); }
.results-count { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); flex: 1; }
.results-count strong { color: var(--accent); }
.sort-select { background: var(--surface); border: 1px solid var(--border2); border-radius: 6px; padding: 4px 8px; color: var(--muted2); font-family: 'Space Mono', monospace; font-size: 11px; outline: none; cursor: pointer; }

/* ROULETTE BUTTON */
.roulette-btn { 
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 8px; font-size: 15px; cursor: pointer; 
  border: 1.5px solid var(--border2); background: var(--surface); 
  flex-shrink: 0; transition: all 0.18s; 
  padding: 0; line-height: 1;
}
.roulette-btn:hover { border-color: var(--accent); background: var(--surface2); transform: scale(1.08); }
.roulette-btn:active { transform: scale(0.9); }
@keyframes rouletteSpin { 0%{transform:rotate(0deg) scale(1)} 50%{transform:rotate(360deg) scale(1.2)} 100%{transform:rotate(360deg) scale(1)} }
.roulette-btn.spinning { animation: rouletteSpin 0.45s ease; pointer-events: none; }

/* LIST */
#listContainer { padding: 12px 16px 140px; }

.ex-card { 
  background: var(--surface); 
  border: 1px solid var(--border); 
  border-radius: 10px; 
  margin-bottom: 8px; 
  overflow: hidden; 
  transition: border-color 0.15s; 
  cursor: pointer; 
}
.ex-card.expanded {
  border-color: var(--border2);
  background: #161616;
}

.ex-card-main { 
  display: flex; 
  align-items: flex-start; 
  padding: 12px 14px; 
  gap: 12px; 
}

.muscle-bar { 
  width: 4px; 
  height: 38px; 
  border-radius: 2px; 
  flex-shrink: 0; 
  margin-top: 2px; 
}

.ex-info { flex: 1; min-width: 0; }

.ex-name { 
  font-size: 14px; 
  font-weight: 700; 
  line-height: 1.3; 
  margin-bottom: 4px; 
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.ex-card.expanded .ex-name {
  display: block;
  overflow: visible;
  -webkit-line-clamp: unset;
}

.ex-sub { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
.ex-sub .tag { display: inline-flex; align-items: center; justify-content: center; }
.tag { font-family: 'Space Mono', monospace; font-size: 10px; padding: 2px 7px; border-radius: 4px; display: inline-flex; align-items: center; line-height: 1.4; }
.tag-muscle { background: rgba(255,255,255,0.07); color: #bbb; }

.tag-diff.novice      { background: rgba(56,189,248,0.15);  color: #38bdf8; }
.tag-diff.beginner    { background: rgba(74,222,128,0.15);  color: #4ade80; }
.tag-diff.intermediate{ background: rgba(250,204,21,0.15);  color: #facc15; }
.tag-diff.advanced    { background: rgba(251,146,60,0.15);  color: #fb923c; }
.tag-diff.expert      { background: rgba(248,113,113,0.15); color: #f87171; }
.tag-diff.master      { background: rgba(192,132,252,0.15); color: #c084fc; }

.tag-equip { background: rgba(255,255,255,0.06); color: #aaa; }
.ex-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; margin-top: 2px; }
.yt-icon { opacity: 0.5; flex-shrink: 0; }
.ex-card.expanded .yt-icon { display: none; }
.ex-card:not(.expanded) .add-session-btn { display: none; }
.ex-card:not(.expanded) .map-btn { display: none; }
.chevron { display: none; }

.map-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.15s, color 0.15s;
  flex-shrink: 0; color: var(--muted2);
}
.map-btn:hover { transform: scale(1.2); color: var(--accent); }
.map-btn svg { width: 16px; height: 16px; }

.heart-btn {
  background: none; border: none; cursor: pointer; padding: 4px; border-radius: 6px;
  display: flex; align-items: center; justify-content: center; transition: transform 0.15s;
  flex-shrink: 0;
}
.heart-btn:hover { transform: scale(1.2); }
.heart-btn svg { width: 20px; height: 20px; min-width: 18px; min-height: 18px; transition: all 0.2s; }
.heart-btn.favorited svg { fill: var(--heart); stroke: var(--heart); filter: drop-shadow(0 0 4px rgba(255,77,109,0.5)); }
.heart-btn:not(.favorited) svg { fill: none; stroke: var(--muted2); }

/* DETAIL */
.ex-detail { display: none; padding: 0 14px 14px; border-top: 1px solid var(--border); }
.ex-card.expanded .ex-detail { display: block; }
.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
.detail-item label { font-family: 'Space Mono', monospace; font-size: 9px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); display: block; margin-bottom: 3px; }
.detail-item p { font-size: 13px; font-weight: 600; color: var(--text); }
.detail-item.full { grid-column: 1 / -1; }
.video-btn { margin-top: 12px; display: flex; align-items: center; gap: 8px; background: #ff0000; color: white; padding: 10px 16px; border-radius: 8px; font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; cursor: pointer; border: none; width: 100%; justify-content: center; text-decoration: none; transition: background 0.15s; }
.video-btn:hover { background: #cc0000; }

/* MUSCLE DIAGRAM */
.muscle-diagram-wrap {
  grid-column: 1 / -1; display: flex; gap: 0; align-items: flex-start;
  margin-top: 10px; padding: 12px 4px 10px; border-radius: 10px;
  background: #080808; border: 1px solid #1a1a1a;
}
.diagram-col { display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; min-width: 0; }
.diagram-col svg { width: 100%; max-width: 120px; height: auto; display: block; }
.diagram-label { font-family: 'Space Mono', monospace; font-size: 8px; text-transform: uppercase; letter-spacing: 0.14em; color: #383838; text-align: center; }
.body-svg polygon { fill: #1f1f1f; stroke: none; transition: fill 0.2s ease, filter 0.2s ease; }
.body-svg polygon.hi { fill: #e8ff47; filter: drop-shadow(0 0 5px rgba(232,255,71,0.5)); }
.diagram-col.dim { opacity: 0.18; }
.diagram-divider { width: 1px; background: #1c1c1c; align-self: stretch; margin: 6px 0; flex-shrink: 0; }

/* LOADING */
.loading-state { text-align: center; padding: 60px 20px; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 13px; }
.spinner { width: 32px; height: 32px; border: 3px solid var(--border2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state { text-align: center; padding: 60px 20px; color: var(--muted); font-family: 'Space Mono', monospace; font-size: 13px; }
.load-more-btn { display: block; width: 100%; padding: 14px; background: var(--surface); border: 1px solid var(--border2); border-radius: 10px; color: var(--muted2); font-family: 'Space Mono', monospace; font-size: 12px; cursor: pointer; text-align: center; margin-top: 8px; transition: all 0.15s; }

/* PIN MODAL */
#pinModal { display: none; position: fixed; inset: 0; z-index: 9000; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
#pinModal.open { display: flex; }
.pin-box { background: var(--surface); border: 1px solid var(--border2); border-radius: 16px; padding: 32px; width: 300px; text-align: center; }
.pin-btn { width: 100%; padding: 12px; background: var(--accent); color: #0a0a0a; border: none; border-radius: 8px; font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; margin-bottom: 8px; }

/* EDIT PANEL */
#editPanel { display: none; position: fixed; inset: 0; z-index: 500; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); overflow-y: auto; padding: 20px; }
#editPanel.open { display: flex; flex-direction: column; align-items: center; }
.edit-panel-inner { background: var(--surface); border: 1px solid var(--border2); border-radius: 16px; width: 100%; max-width: 600px; padding: 24px; margin: auto; }

/* TOAST */
.toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #0a0a0a; padding: 10px 20px; border-radius: 8px; font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; z-index: 9999; opacity: 0; transition: opacity 0.3s, bottom 0.35s cubic-bezier(0.4,0,0.2,1); pointer-events: none; white-space: nowrap; max-width: calc(100vw - 32px); text-align: center; }
.toast.tray-up { bottom: 180px; }
.toast.show { opacity: 1; }

/* SESSION TRAY */
#sessionTray {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 400;
  background: #0f0f0f; border-top: 1px solid var(--border2);
  padding: 0 16px; max-height: 0; overflow: hidden;
  transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1), padding 0.35s;
  backdrop-filter: blur(12px);
}
#sessionTray.visible { max-height: 320px; padding: 14px 16px 20px; }
.tray-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.tray-title { font-family: 'Space Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.14em; color: var(--muted2); display: flex; align-items: center; gap: 8px; }
.tray-count { background: var(--accent); color: #0a0a0a; font-size: 10px; font-weight: 700; border-radius: 999px; padding: 1px 7px; }
.tray-share-btn { background: var(--accent); color: #0a0a0a; border: none; border-radius: 7px; padding: 7px 14px; font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700; cursor: pointer; }
.tray-clear-btn { background: none; border: 1px solid var(--border2); border-radius: 7px; color: var(--muted2); padding: 7px 10px; font-family: 'Space Mono', monospace; font-size: 11px; cursor: pointer; }
.tray-list { display: flex; flex-direction: column; gap: 5px; max-height: 200px; overflow-y: auto; scrollbar-width: none; }
.tray-item { display: flex; align-items: center; gap: 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; cursor: pointer; }
.tray-item-name { flex: 1; font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* EXPLORER OVERLAY */
#explorerOverlay { display: none; position: fixed; inset: 0; z-index: 300; background: #050505; flex-direction: column; overflow: hidden; }
#explorerOverlay.open { display: flex; }

/* WHEEL OVERLAY */
#wheelOverlay { display: none; position: fixed; inset: 0; z-index: 600; background: rgba(0,0,0,0.96); backdrop-filter: blur(12px); flex-direction: column; align-items: center; justify-content: center; }
#wheelOverlay.open { display: flex; }

@media (max-width: 500px) {
  .detail-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="installBanner">
  <div class="bt"><strong>Add to Home Screen</strong>Tap Share then "Add to Home Screen"</div>
  <button onclick="dismissBanner()">Got it</button>
</div>

<button id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18 15 12 9 6 15"/></svg></button>

<div class="toast" id="toast"></div>

<header>
  <div class="header-top">
    <div class="logo" id="logoBtn">Wilde<span>.</span></div>
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="search" id="searchInput" placeholder="Search exercises..." autocomplete="off">
    </div>
    <button class="filter-toggle-btn" id="filterToggleBtn" onclick="toggleFilterDrawer()"><span class="filter-dot"></span>Filters</button>
    <button class="explorer-btn" id="explorerBtn" onclick="openExplorer()">Map</button>
  </div>
</header>

<div id="filterDrawer">
  <div class="filter-section">
    <div class="filter-label">Muscle</div><div class="filter-row" id="muscleRow"></div>
    <div class="filter-label">Difficulty</div>
    <div class="filter-row" id="diffRow">
      <div class="pill active" onclick="setDiff('all',this)">All</div>
      <div class="pill diff-novice" onclick="setDiff('Novice',this)">Novice</div>
      <div class="pill diff-beginner" onclick="setDiff('Beginner',this)">Beginner</div>
      <div class="pill diff-intermediate" onclick="setDiff('Intermediate',this)">Intermediate</div>
      <div class="pill diff-advanced" onclick="setDiff('Advanced',this)">Advanced</div>
      <div class="pill diff-expert" onclick="setDiff('Expert',this)">Expert</div>
      <div class="pill diff-master" onclick="setDiff('Master',this)">Master</div>
      <div class="pill fav-pill" id="favPill" onclick="toggleFavFilter(this)">Saved</div>
    </div>
  </div>
</div>

<div class="results-bar">
  <div class="results-count">Showing <strong id="countDisplay">0</strong> exercises</div>
  <button class="roulette-btn" id="rouletteBtn" onclick="exerciseRoulette()">ðŸŽ²</button>
  <select class="sort-select" id="sortSelect" onchange="render()">
    <option value="default">Sort: Default</option>
    <option value="az">A â†’ Z</option>
    <option value="diff-asc">Easiest first</option>
  </select>
</div>

<div id="listContainer"><div class="loading-state"><div class="spinner"></div>Loading...</div></div>

<div id="sessionTray">
  <div class="tray-header">
    <div class="tray-title">Session <span class="tray-count" id="trayCount">0</span></div>
    <div class="tray-actions">
      <button class="tray-clear-btn" onclick="clearSession()">Clear</button>
      <button class="tray-share-btn" onclick="shareSession()">Share</button>
    </div>
  </div>
  <div class="tray-list" id="trayList"></div>
</div>

<script>
const SUPABASE_URL = 'https://spwoicclxqoxqkfkmcrw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwd29pY2NseHFveHFrZmttY3J3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MzIzNDMsImV4cCI6MjA4NzIwODM0M30.QhrV6CqGMVpCu_ySygeATvF_hvGoGmgYzbocp9A-qX0';
const PASSWORD = 'Wilde';

const MUSCLE_COLORS = {
  Chest:'#60a5fa', Back:'#3b82f6', Shoulders:'#93c5fd', Traps:'#7dd3fc',
  Biceps:'#a5b4fc', Triceps:'#818cf8', Forearms:'#c4b5fd', Core:'#34d399',
  Quads:'#f472b6', Hamstrings:'#fb7185', Glutes:'#f43f5e', Calves:'#fda4af',
  Hips:'#fb923c', 'Ankles/Feet':'#facc15',
};
const MUSCLES_LIST = ['Ankles/Feet','Back','Biceps','Calves','Chest','Core','Forearms','Glutes','Hamstrings','Hips','Quads','Shoulders','Traps','Triceps'];
const DIFFS_LIST = ['Novice','Beginner','Intermediate','Advanced','Expert','Master','Legendary','Grand Master'];

const SESSION_KEY = 'wilde_session';

// â”€â”€ SEARCH: synonym map + token matching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEARCH_SYNONYMS = {
  'one arm':    'single arm',
  'one-arm':    'single arm',
  'two arm':    'double',
  'two-arm':    'double',
  'both arms':  'double',
  'db':         'dumbbell',
  'dbs':        'dumbbell',
  'kb':         'kettlebell',
  'kbs':        'kettlebell',
  'bb':         'barbell',
  'rdl':        'romanian deadlift',
  'ohp':        'overhead press',
  'bp':         'bench press',
  'push up':    'push-up',
  'pull up':    'pull-up',
  'chin up':    'chin-up',
  'push-up':    'push up',
  'pull-up':    'pull up',
  'chin-up':    'chin up',
  'sl ':        'single leg ',
  'single leg': 'single-leg',
  'single-leg': 'single leg',
};

function expandQuery(raw) {
  let q = raw.toLowerCase().trim();
  const sorted = Object.keys(SEARCH_SYNONYMS).sort((a,b) => b.length - a.length);
  for (const alias of sorted) {
    if (q.includes(alias)) q = q.split(alias).join(SEARCH_SYNONYMS[alias]);
  }
  return [...new Set(q.split(/\s+/).filter(t => t.length >= 2))];
}

function exerciseMatchesSearch(ex, tokens) {
  if (!tokens.length) return true;
  const haystack = [ex.n, ex.m, ex.s, ex.e, ex.mv, ex.d]
    .filter(Boolean).join(' ').toLowerCase();
  return tokens.every(token => haystack.includes(token));
}

let exercises = [];
let favoriteIds = new Set();
let sessionList = [];
let currentRegion = 'all';
let currentMuscle = 'all';
let currentDiff = 'all';
let currentSearch = '';
let currentSearchTokens = [];
let showFavoritesOnly = false;
let displayCount = 40;
let expandedId = null;

async function loadExercises() {
  try {
    const res = await fetch(SUPABASE_URL + '/rest/v1/exercises?select=*', {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
    });
    exercises = await res.json();
    exercises = exercises.sort(() => Math.random() - 0.5);
    buildMusclePills('all');
    await loadFavorites();
    loadSessionFromStorage();
    updateSessionTray();
    render();
  } catch(e) {
    document.getElementById('listContainer').innerHTML = 'Error loading.';
  }
}

function buildMusclePills(region) {
  const row = document.getElementById('muscleRow');
  row.innerHTML = `<div class="pill active" onclick="setMuscle('all',this)">All</div>` +
    MUSCLES_LIST.map(m=>`<div class="pill" onclick="setMuscle('${m}',this)">${m}</div>`).join('');
}

function setMuscle(m, el) {
  currentMuscle = m; displayCount = 40;
  document.querySelectorAll('#muscleRow .pill').forEach(p=>p.classList.remove('active')); el.classList.add('active'); render();
}

function setDiff(d, el) {
  currentDiff = d; displayCount = 40;
  document.querySelectorAll('#diffRow .pill').forEach(p=>p.classList.remove('active')); el.classList.add('active'); render();
}

document.getElementById('searchInput').addEventListener('input', e => {
  currentSearch = e.target.value.trim();
  currentSearchTokens = currentSearch ? expandQuery(currentSearch) : [];
  displayCount = 40; render();
});

function getFiltered() {
  let list = exercises;
  if (showFavoritesOnly) list = list.filter(e => favoriteIds.has(e.id));
  if (currentMuscle !== 'all') list = list.filter(e => e.m === currentMuscle);
  if (currentDiff !== 'all') list = list.filter(e => e.d === currentDiff);
  if (currentSearchTokens.length) list = list.filter(e => exerciseMatchesSearch(e, currentSearchTokens));
  return list;
}

function render() {
  const filtered = getFiltered();
  const shown = filtered.slice(0, displayCount);
  document.getElementById('countDisplay').textContent = filtered.length;
  document.getElementById('listContainer').innerHTML = shown.map(ex => renderCard(ex)).join('');
}

function renderCard(ex) {
  const color = MUSCLE_COLORS[ex.m] || '#888';
  const isExpanded = expandedId === ex.id;
  return `
    <div class="ex-card${isExpanded?' expanded':''}" onclick="toggleCard(${ex.id})">
      <div class="ex-card-main">
        <div class="muscle-bar" style="background:${color}"></div>
        <div class="ex-info">
          <div class="ex-name">${ex.n}</div>
          <div class="ex-sub">
            <span class="tag tag-muscle">${ex.m}</span>
            <span class="tag tag-diff ${ex.d.toLowerCase()}">${ex.d}</span>
          </div>
        </div>
        <div class="ex-right">
          <button class="tray-clear-btn" onclick="event.stopPropagation();toggleSession(${ex.id}, event)">+</button>
        </div>
      </div>
    </div>`;
}

function toggleCard(id) { expandedId = expandedId === id ? null : id; render(); }

function saveSessionToStorage() {
  try { localStorage.setItem('wilde_session', JSON.stringify(sessionList)); } catch(e) {}
}
function loadSessionFromStorage() {
  try {
    const saved = localStorage.getItem('wilde_session');
    if (saved) sessionList = JSON.parse(saved);
  } catch(e) { sessionList = []; }
}

function toggleSession(id, event) {
  const ex = exercises.find(e => e.id === id);
  const idx = sessionList.findIndex(s => s.id === id);
  if (idx > -1) sessionList.splice(idx, 1);
  else sessionList.push({ id: ex.id, name: ex.n });
  updateSessionTray();
  saveSessionToStorage();
}

function removeFromSession(id) {
  sessionList = sessionList.filter(s => s.id !== id);
  updateSessionTray();
  saveSessionToStorage();
}

function clearSession() {
  sessionList = [];
  updateSessionTray();
  saveSessionToStorage();
}

function updateSessionTray() {
  const tray = document.getElementById('sessionTray');
  const count = document.getElementById('trayCount');
  count.textContent = sessionList.length;
  tray.classList.toggle('visible', sessionList.length > 0);
  document.getElementById('trayList').innerHTML = sessionList.map(s => `
    <div class="tray-item" onclick="goToExerciseFromTray(${s.id})">
      <span class="tray-item-name">${s.name}</span>
      <button onclick="event.stopPropagation();removeFromSession(${s.id})">Ã—</button>
    </div>`).join('');
}

function goToExerciseFromTray(id) {
  currentSearch = '';
  currentSearchTokens = [];
  expandedId = id;
  render();
}

async function loadFavorites() { /* Load Logic */ }
function toggleFilterDrawer() { document.getElementById('filterDrawer').classList.toggle('open'); }
function openExplorer() { /* Explorer Logic */ }
function exerciseRoulette() { /* Roulette Logic */ }
function wheelGo() { currentSearch = ''; currentSearchTokens = []; }

loadExercises();
</script>
</body>
</html>
